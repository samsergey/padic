Сегодня я хочу заглянуть с вами в один любопытный уголок математики, в котором обитают необычные создания -- p-адические числа, а попутно рассказать о написанной мной Haskell-библиотеке для работы с ними и о двух классных инструментах: о типах-литералах (type literals) и семействах типов (type families), приближающих нас к заветным зависимым типам.

Я люблю язык Haskell и, начиная с какого-то времени, мне стало комфортно на нём думать на математические темы. Когда мне понадобилось освоить новый инструмент, -- p-адические числа, оказалось, что в репозитории [hackage](https://hackage.haskell.org/), основном для Haskell-сообщества, нет библиотеки для работы с ними, даже в таких серьёзных теоретико-числовых библиотеках, как [arithmetic](https://hackage.haskell.org/package/arithmetic), [arithmoi](https://hackage.haskell.org/package/arithmoi) или [factory](https://hackage.haskell.org/package/factory). В конце концов, я написал и опубликовал свой модуль [padic](https://github.com/samsergey/padic), и в конце этой статьи расскажу о некоторых деталях его реализации. Но в основном, речь пойдёт о p-адических числах. Мы постараемся не сильно уходить в теорию, постоянно держа практические аспекты в поле зрения.

<cut />

В арсенале профессионалов и настоящих мастеров подчас попадаются странные инструменты. Не сразу можно сказать для чего они нужны и как они, вообще, могут быть полезными. Но при решении каких-то особенных задач они оказываются незаменимыми. Начиная с какого-то уровня погружения в теорию чисел, алгебраическую геометрию, квантовую механику или теорию струн, авторы книг и статей зачастую переходят от привычных целых и вещественных чисел к p-адическим числам и при этом удивительным образом чувствуют, что им становится легче. У меня, по крайней мере, первое знакомство с ними ощущения лёгкости не создало. В сети достаточно много вводных материалов по этой теме, как виде книг, статей и блогов, так и в форме видео. Большинство из этих введений начинается с определения p-адической нормы, а завершается упоминанием фрактальной (канторовой) топологии, которую эти числа образуют. При этом приводится пара канонических примеров необычности этой числовой системы, таких как сходимость суммы всех положительных степеней двойки к минус единице или возможность получить целочисленные квадратные корни из 2, 5 или 7. В более серьёзных книгах всё внезапно становится существенно более сложным, поскольку авторам вдруг становится важно не то как складывать и умножать эти числа, а то что они образуют *проективный предел колец вычетов относительно естественных проекций* или что *образуемое ими метрическое пространство неархимедово*. Это похоже на ситуацию с многочисленными введениями в монады, ну, вы понимаете о чём я... Поэтому мы сегодня, отталкиваясь от вполне понятных и несложных вещей, постараемся пройти несколько дальше и понять в чём практический смысл введения этих числовых монстров.

--------------

## Начинаем с цифр

Что мы имеем в виду, когда записываем число рядом цифр? -- То, что его можно  представить в виде взвешенной суммы степеней некоторого основания, натурального числа, не равного нулю или единице. Обычно мы работаем с основанием 10, равным числу пальцев на руках, в "цифровом" мире повсеместно используется самое маленькое из возможных основание 2, ну, а при записи времени нам оказалось удобным использовать смешанную систему с основаниями 12 и 60. В позиционной записи числа цифры выбираются из конечного множества возможных остатков деления на основание, а позиция цифры в ряду, обозначающем число, соответствует степени основания. Это всё привычно и поэтому кажется простым. Более того, в повседневности мы складываем и вычитаем, умножаем и делим, а также сравниваем не числа, а их позиционную запись (расширенную знаком "минус" для отрицательных чисел), а это значит, мы рассчитываем на то, что множество чисел и множество их позиционных представлений "работают" одинаково. Если мы выберем в качестве представления числа не цепочки цифр, а какие-то количественные меры, например, шаги на бесконечной ленте, то результаты сложения "в столбик по цифрам" и непосредственно по шагам на этой ленте будут согласованы. Это же относится и к другим операциям и свойствам. Говоря на языке математики, мы рассчитываем на изоморфизм между двумя числовыми системами: системой целых чисел и системой, которое образуют последовательности цифр вместе со знакомыми нам со школы операциями поразрядного сложения, вычитания и умножения. Более того, цифры при выполнении этих операций тоже ведут себя как элементы числовой системы -- системы вычетов по модулю выбранного основания. Это значит, что цифры тоже можно складывать, вычитать и умножать, но по правилам модулярной арифметики, у которой тоже есть хорошо знакомый нам "нецифровой" аналог: шаги по замкнутой ленте.


## Начинаем с цифр

Что мы имеем в виду, когда записываем число рядом цифр? -- То, что его можно  представить в виде взвешенной суммы степеней некоторого **основания**, натурального числа, не равного нулю или единице. Обычно мы работаем с основанием 10, равным числу пальцев на руках, в "цифровом" мире повсеместно используется самое маленькое из возможных основание 2, ну, а при записи времени нам оказалось удобным использовать смешанную систему с основаниями 12 и 60. В позиционной записи числа цифры выбираются из конечного множества возможных остатков деления на основание, а позиция цифры в ряду, обозначающем число, соответствует степени основания. Это всё привычно и поэтому кажется простым. Более того, в повседневности мы складываем и вычитаем, умножаем и делим, а также сравниваем не числа, а их позиционную запись (расширенную знаком "минус" для отрицательных чисел), а это значит, мы рассчитываем на то, что множество чисел и множество их позиционных представлений "работают" одинаково. Если мы выберем в качестве представления числа не цепочки цифр, а какие-то количественные меры, например, шаги на бесконечной ленте, то результаты сложения "в столбик" и непосредственно шагами на этой ленте будут согласованы между собой. Это же относится и к другим числовым операциям и свойствам. Говоря на языке математики, мы рассчитываем на **изоморфизм** между двумя числовыми системами: *системой целых чисел* и системой, которое образуют *последовательности цифр* вместе со знакомыми нам со школы операциями поразрядного сложения, вычитания и умножения. 

Более того, цифры при выполнении арифметических операций тоже ведут себя как элементы своей числовой системы. Это значит, что цифры тоже можно складывать, вычитать и умножать, но по особым правилам **модулярной арифметики**, у которой тоже есть хорошо знакомый нам "нецифровой" аналог: шаги по замкнутой ленте.

Далее я буду использовать математические имена и обозначения для этих числовых систем. Система целых чисел (изоморфная шагам по бесконечной в обе стороны ленте) является [кольцом](https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%BC%D0%BC%D1%83%D1%82%D0%B0%D1%82%D0%B8%D0%B2%D0%BD%D0%BE%D0%B5_%D0%BA%D0%BE%D0%BB%D1%8C%D1%86%D0%BE) и обозначается  $inline$\mathbb{Z}.$inline$ Цифры, используемые при записи числа в позиционной записи с основанием $inline$b$inline$ образуют [кольцо вычетов](https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%BB%D1%8C%D1%86%D0%BE_%D0%B2%D1%8B%D1%87%D0%B5%D1%82%D0%BE%D0%B2) по модулю $inline$m$inline$, которое мы будем обозначать как $inline$\mathbb{Z}/m\mathbb{Z}$inline$. Эта система изоморфна шагам по замкнутой ленте, вмещающей ровно $inline$m$inline$ ячеек или отметок. 

В кольце можно складывать, вычитать и перемножать любые элементы, получая результаты, принадлежащие  этому же кольцу. А вот деление возможно не всегда, например, в кольце $inline$\mathbb{Z}$inline$ нет такого элемента, который был бы равен $inline$2/3$inline$, то есть, решал бы уравнение $inline$3x=2$inline$. Для того, чтобы можно было делить на любой ненулевой элемент, кольцо $inline$\mathbb{Z}$inline$ расширяется до [поля](https://ru.wikipedia.org/wiki/%D0%9F%D0%BE%D0%BB%D0%B5_(%D0%B0%D0%BB%D0%B3%D0%B5%D0%B1%D1%80%D0%B0)) рациональных чисел $inline$\mathbb{Q}$inline$.

Кольца вычетов конечны, и может показаться, что их возможности меньше бесконечного кольца целых чисел, но это не так. В них, даже в совсем небольших, можно обнаружить то, чего нет в целых числах. Например, в кольце $inline$\mathbb{Z}/5\mathbb{Z}$inline$ из пяти элементов $inline$\{0,1,2,3,4\}$inline$ у каждого элемента есть противоположный, то есть такой, что в сумме они дают ноль. То есть, в этом смысле оно включает в себя "отрицательные числа": $inline$1 = -4,\ \ 2 = -3,\ \  3 = -2,\ \ 4 = -1$inline$. Более того, в этой системе у любого корректного линейного уравнения есть решение, то есть, у каждого ненулевого элемента есть обратный, такой, что их произведение равно еднице. Таким образом, оно содержит в себе все возможные формальные дроби: $inline$1 = 1/4 = 3/2,\ \  2 = 1/3 = 3/4,$inline$ $inline$ 3 = 1/2 = 4/3,\ \  4 = 2/3$inline$. Значит, это уже не только кольцо, но и поле. Каждое кольцо вычетов по модулю, являющемуся простым числом, образует поле.

Но это ещё не все "сокровища". В кольце $inline$\mathbb{Z}/5\mathbb{Z}$inline$ есть то, чего нет ни в целых, ни в рациональных числах, например, решение уравнения $inline$x^2 +1 = 0$inline$, то есть, $inline$\sqrt{-1}$inline$, ведь $inline$2^2 = \equiv 4 = -1 \mod 5$inline$. Это, впрочем, вовсе не значит, что 2 -- это *мнимая единица*, это рядовой элемент конечного поля. 

Кольца вычетов разные и у каждого есть свои интересные особенности, например, в кольце привычных нам цифр $inline$\mathbb{Z}/10\mathbb{Z}$inline$ нет всех возможных дробей, но зато в нём есть делители нуля, то есть, такие ненулевые числа, которые в произведении дают 0. А ещё в нём есть числа, равные своим квадратам: это 5 и 6 (помните рифмы в таблице умножения: *"пятью-пять -- двадцать пять, шестью-шесть -- тридцать шесть"*?). Таким образом, уравнение $inline$x(x-1) = 0$inline$ имеет в этом кольце целых четыре различных корня из которых два нетривиальны! 


## Поднимаемся выше

Каждое кольцо вычетов порождает целое семейство "потомков", которым они передают часть своих особенностей, но которые способны пойти дальше своего "родителя". Потомками кольцá $inline$\mathbb{Z}/m\mathbb{Z}$inline$ можно считать кóльца $inline$\mathbb{Z}/m^2\mathbb{Z}$inline$, $inline$\mathbb{Z}/m^3\mathbb{Z}$inline$ и т.д. Рассмотрим, например, кольцо $inline$\mathbb{Z}/25\mathbb{Z}$inline$. В нём, как и у его родителя $inline$\mathbb{Z}/5\mathbb{Z}$inline$ тоже есть все противоположные числа и большая часть дробей (кроме тех, что имеют знаменатель, кратный $inline$5$inline$). Имеется в нём и $inline$\sqrt{-1} = \pm7$inline$, а также появляются корни из $inline$\pm6$inline$ и $inline$\pm11$inline$, которых не могло быть в $inline$\mathbb{Z}/5\mathbb{Z}$inline$. В кольце $inline$\mathbb{Z}/125\mathbb{Z}$inline$ остаётся всё то же, что было у "предков", но расширяется набор квадратных уравнений, имеющих решения и появляется возможность решать некоторые кубические уравнения. 

А интересно, если продолжать наращивать степени и новые возможности, то какими свойствами будет обладать кольцо $inline$\mathbb{Z}/5^\infty\mathbb{Z}$inline$? На этот вопрос и ответил Курт Гензель, определив для такого предельного кольца числовую систему и описав его свойства. Система $inline$\mathbb{Z}/p^\infty\mathbb{Z}$inline$, порождаемая кольцом вычетов $inline$\mathbb{Z}/p\mathbb{Z}$inline$ называется **системой целых p-адических чисел** и обозначается $inline$\mathbb{Z}_p$inline$. Она включает в себя всех своих родителей, как подкольца и обладает всеми их свойствами сразу! Однако при устремлении к бесконечности, количество переходит в качество, и мы получаем нечто новое: бесконечное кольцо, которое включает в себя в качестве подкольца всё $inline$\mathbb{Z}$inline$ целиком, и кроме того, содержит все формальные дроби со знаменателями, не кратными основанию $inline$p$inline$, а также решения широкого класса алгебраических уравнений линейных, квадратных и высших степеней! Не любых, конечно, а только тех, что решаются в кольцах-родителях, но это "не баг, а фича", поскольку позволяет относительно легко ответить на вопрос о существовании решения у заданного алгебраического уравнения, который в целых или рациональных числах представляет крайне сложную задачу. Достаточно вспомнить, Великую теорему Ферма о существовании решения уравнения $inline$x^n + y^n = z^n$inline$ в целых числах, на доказательство которой ушло три столетия, и не удивительно, что в том доказательстве, что представил Энрю Уайлз, используются p-адические числа. 

Но это ещё не всё, что можно построить "поднимая" кольца вычетов до предельных колец целых p-адических чисел. Запрет на дроби со знаменателем, кратным основанию $inline$p$inline$, достаточно жестко ограничивает нас в выборе доступных математических инструментов. Его можно изящно обойти, используя приём хорошо знакомый физикам и инженерам: разбить число на мантиссу и экспоненту. Любое рациональное число можно разложить в произведение $inline$u \cdot p^v$inline$, в котором число $inline$u \in \mathbb{Z}_p$inline$ -- обратимое целое p-адическое число (для которого всегда можно вычислить $inline$u^{-1}$inline$), а $inline$v \in \mathbb{Z}$inline$ -- показатель степени при основании $inline$p$inline$. Таким образом, рассматривая числа $inline$y_1 = u_1 \cdot p^{v_1}$inline$ и $inline$y_2 = u_2 \cdot p^{v_2}$inline$, мы всегда сможем найти их отношение $inline$\frac{y_1}{y_2} = \frac{u_1}{u_2}\cdot p^{v_1-v_2}$inline$. Этот приём позволяет нам дополнить кольцо целых p-алических чисел $inline$\mathbb{Z}_p$inline$ до поля рациональных p-адических чисел $inline$\mathbb{Q}_p$inline$. Если $inline$p$inline$ -- простое число, то у нас этот трюк точно получится, поскольку в этом случае кольцо $inline$\mathbb{Z}/p\mathbb{Z}$inline$ не содержит делителей нуля, которые обязаны в случае простого $inline$p$inline$ содержать в себе его в качестве множителя. Однако все такие множители мы вынесли в выражение $inline$p^v$inline$, а значит, любое число $inline$u$inline$ будет обратимым. 

При работе с позиционными системами счисления выгодно в качестве основания выбирать число с большим количеством множителей, это упрощает таблицу умножения. Число 10 в этом отношении не оптимальное, основания 12, 24 или 60 существенно выгоднее и все они используются человечеством, как основания с древнейших времён. Однако для работы с p-адическими числами составные основания хуже простых, поскольку не дают преимуществ поля. Так что часто в самом начале статей и книг сразу оговаривают, что число $inline$p$inline$ в p-адической системе -- простое.

Итак, несложный трюк помог нам повысить статус p-адических чисел до полноценного поля, которое теперь включает в себя в качестве подкольца целиком *всё кольцо целых чисел* $inline$\mathbb{Z}$inline$, а в качесте подполя целиком *всё поле рациональных чисел* $inline$\mathbb{Q}$inline$, а помимо них бесконечное множество других элементов, решающих алгебраические уравнения! 

Конечные поля вычетов (алгебра простых цифр), которые лежат в основе p-адических чисел, существенно проще для анализа чем натуральные числа. Там, конечно, тоже хватает технических трудностей, но к ним проще подступиться потому, хотя бы, что поля эти конечны. Очень многие общие результаты теории чисел и алгебраической геометрии могут быть получены переходом к 2-адическим числам, которые, как мы теперь понимаем, можно рассматривать как бесконечноразрядные двоичные дроби.

Но, возникает вопрос: откуда же взялись все эти дополнительные числа? Описанный нами процесс повышения степени колец вычетов $inline$\mathbb{Z}/p\mathbb{Z} \to \mathbb{Z}/p^2\mathbb{Z} \to \mathbb{Z}/p^2\mathbb{Z} \to ...$inline$ всё время расширял кольца новыми *целыми числами*, принадлежащими кольцам $inline$\mathbb{Z}/p^k\mathbb{Z}$inline$. Все наши формальные дроби и квадратные корни всегда совпадали с какими-то целыми числами и были от них неотличимы. Значит ли это, что и в $inline$\mathbb{Z}_p$inline$ дроби и алгебраические корни тоже будут какими-то целыми числами, совпадающими с "нормальными". И да и нет. Да -- они все будут целыми, нет -- они все будут отличаться и друг от друга и от элементов подкольца $inline$\mathbb{Z}_p$inline$. Тут работает магия предельного перехода.

## Возвращаемся к цифрам

Что мы делаем, когда хотим выразить сложную мысль? -- используем много букв. А если нужно выразить большое целое число? -- тогда нужно использовать много цифр и позиционную запись. С помощью привычной нам позиционной системы счисления можно выражать и p-адические числа.

Начём опять с маленького кольца $inline$\mathbb{Z}/5\mathbb{Z}$inline$. Все его элементы принадлежат множеству цифр $inline$\{0,1,2,3,4\}$inline$. Поднимемся на ступень выше и перейдём в кольцо $inline$\mathbb{Z}/25\mathbb{Z}$inline$. Можно каждому элементу этого кольца назначить свой символ, скажем, из английского алфавита, а можно воспользоваться тем, что в этом кольце ровно $inline$5 \times 5$inline$ элементов, ни больше ни меньше, а значит каждому из них можно поставить в соответствие пару цифр, и таких пар будет в точности $inline$5\times 5$inline$. Это соответствие можно сделать не каким попало, а естественным, то есть таким, которое сможет сохранить числовые свойства цифр и элементов $inline$\mathbb{Z}/25\mathbb{Z}$inline$. Для этого достаточно использовать принципы позиционной записи, представив числа из $inline$\mathbb{Z}/25\mathbb{Z}$inline$ как сумму $inline$5b + a$inline$ используя цифры $inline$a, b \in \mathbb{Z}/5\mathbb{Z}$inline$. Получим хорошо знакомую пятиричную систему счисления, которая позволяет подниматься по степеням основания, повышая разрядность записи числа. Так для записи любого числа из $inline$\mathbb{Z}/5^k\mathbb{Z}$inline$ потребуется цепочка из $inline$k$inline$ пятиричных цифр. 

Самое главное достоинство такого представления состоит в изоморфизме между числами и их позиционном представлении, о котором говорилось в самом начале статьи. Благодаря ему арифметические операции, производимые поразрядно (сложение с переносом, вычитание с "заниманием", умножение "в столбик" и деление "уголком") согласуются с арифметикой чисел, представляемых цепочкой цифр. А это значит, что совершая предельный переход от конечных колец к бесконечному, мы получаем возможность записывать 5-адическое число с помощью бесконечной цепочки пятиричных цифр: $$display$$x = \overline{...fedcba}_5 = ... 5^5 f + 5^4 e +  5^3 d + 5^2 c +  5 b + a$$display$$ и автоматом получаем практическую арифметику для p-адических чисел, знакомую со школьной скамьи! Такая запись называется **каноническим разложением** p-адического числа.

И как только число разрядов устремляется к бесконечности, у нас и появляется куча свободного места для дополнительных чисел. Все целые числа записываются конечным числом цифр. Задумайтесь над этим, множество целых чисел не ограничено сверху, однако сколь бы большое число вы ни выбрали (хоть знаменитое число Грэма, хоть его факториал) оно всегда может быть представлено *конечным* числом цифр. Таким образом, любое целое число можно представить как p-адическое, добавив бесконечную цепочку нулей после старшего разряда. Но p-адические числа могут иметь и любые ненулевые числа в своём бесконечном хвосте, который по нашему определению бесконечно длинее любой конечной цепочки цифр в начале. Таким образом, множество p-адических много больше множества целых! Настолько же, насколько множество иррациональных чисел больше множества рациональных. Бесконечное разнообразие бесконечных последовательностей из конечного набора цифр образует континуум!

Добавляя степень основания для перехода к рациональным p-адическим числам, мы вводим аналог десятичной точки, которая разделяет p-адическое число в каноническом разложении на конечную дробную и бесконечную целую части. Давайте посмотрим на примеры некоторых p-адических чисел:
$$display$$\begin{align*}
123 &= 123_{10}\\
123 &= 11120_3\\
-123 &= …9999999999999999999999877_{10} = (9)877_{10} = (4)002_5\\
1/123 &= …69918699186991869918699187_{10} = (69918)7_{10}\\
-\frac{1}{49} &= …66666666666666666666666666666.66_7 = (6).66_7 \\
3/171 &= (7\,12\,10\,0\,5\,12\,1\,1\,10\,9\,4\,7\,3\,11\,5\,3\,2\,6)\,8_{13}\\
0.1234 = \frac{617}{500} &= 0.1234_{10}\\
\frac{617}{500}\cdot\frac1{17} &= …294117647058823529411764705882.3602_{10}\\
\sqrt 17 &= …110110000011111110000010000001_2\\
\sqrt{-1} &= …141421404340423140223032431212_5\\
\end{align*}
$$display$$
В каноническом p-адическом разложении целые числа записываются в виде конечной последовательности цифр (бесконечную цепочку нулей, уходящую налево при записи опускают). Отрицательные целые числа вместо бесконечной цепочки нулей слева имеют бесконечную последовательность наибольшей из цифр (сравните с тем, как в двоичной системе представляются отрицательные числа). В p-адическом разложении цифры рациональных чисел после какой-то конечной цепочки всегда приходят к периодической последовательности. Обратите внимание на то, что запись числа $inline$0.1234$inline$ в десятичной дроби и в виде 10-адического числа совпадают, это не случайно и достаточно удобно: положительные целые и дробные числа с конечным числом цифр имеют одинаковые десятичное и 10-адическое представление.


## Какая от них польза?

Если долго смотреть на бесконечный хвост, уходящий влево, становится не по себе, ведь чем левее цифра, тем старше разряд, то есть, тем больше число. Получается, что почти все p-адические числа в обиходном смысле "бесконечны". Впрочем, "бесконечных" чисел в математике не существует, смысла в них немного. Как же вопринимать числа, записываемые заведомо бесконечным числом разрядов? В некотором смысле, так же, как и числа с бесконечным числом разрядов, но только уходящих направо от десятичной запятой, как в десятичных дробях, к ним-то мы привыкли! Вполне безобидное конечное число $inline$1/3$inline$ имеет в десятичной позиционной системе бесконечную последовательность цифр $inline$0.33333333... = 0.(3)$inline$, так же как и в 10-адической: $inline$...66666667 = (6)7_{10}$inline$. Множество рациональных чисел в десятичной записи тоже включает в себя все натуральные числа, как такое подмножество, у которого справа от десятичной точки начинается бесконечная цепочка нулей. При этом большая часть вещественных чисел, образующих континуум, может быть записана только в виде бесконечной последовательности ненулевых цифр. Так что же, p-адические числа это как p-ричные дроби, записанные наоборот? Простая формальность? Нет, это не так, они круче!

Во некоторых популярных введениях p-адические числа презентуют, как "бесконечноразрядные числа", или как оригинальный способ записывать числа "в обратном порядке" относительно привычно дробной десятичной нотации. Но надо понимать, что цепочки цифр -- это не числа, они образуют вполне самостоятельную алгебраическую структуру, изоморфную (при определённых условиях) той или иной числовой системе. Большую часть вещественных чисел составляют *невычислимые числа*, для которых неизвестен способ их представления в форме цепочки цифр или даже в форме комбинации из вычислимых чисел. Каноническое разложение p-адического числа -- это не p-адические число, а одно из его представлений, причём, не самое удобное или эффективное, просто оно интуитивно понятно в силу нашей привычки оперировать позиционной нотацией. Самое главное, p-адические числа не являются представлением привычных нам целых, рациональных или вещественных чисел, они образуют самостоятельную алгебраическую систему, в которой есть образы инъективных гомоморфизмов (однозначных отображений) из систем вещественных чисел, но есть и иные объекты, у которых нет никаких вещественных аналогов. 

Например, в кольцах с делителями нуля существуют нетривиальные автоморфные числа (числа, которые не меняются при возведении в произвольную натуральную степень). В вещественных и комплексных числах этими свойствами обладают только 0 и 1, а, например, в $inline$\mathbb{Z}_{10}$inline$ есть ещё два таких числа: $inline$…392256259918212890625$inline$ и $inline$…607743740081787109376$inline$, мы встречали их "родителей" ($inline$5$inline$ и $inline$6$inline$) в базовой модулярной арифметике $inline$\mathbb{Z}/10\mathbb{Z}$inline$. А в $inline$\mathbb{Z}_{30}$inline$ таких чисел их уже шесть! Если основание простое и мы имеем дело с полем и нормальной арифметикой, то нетривиальных автоморфных чисел уже не будет.

Важно осознать, что существование однозначного отображения любого рационального и многих алгебраических чисел в p-адическое поле, не гарантирует, что результат вычислений, произведённых с образами этих чисел, имеет вещественный аналог. В общем, перейти p-адический мир не трудно, а вот вернуться оттуда можно не всегда.

Это не так уж и необычно, для числовых систем. Множество вещественных чисел $inline$\mathbb{R}$inline$ включает в себя множество рациональных $inline$\mathbb{Q}$inline$, но кроме него $inline$\mathbb{R}$inline$ содержит в себя все пределы фундаментальных последовательностей, сходящихся в $inline$\mathbb{Q}$inline$, но не ему принадлежащих. Классические примеры таких пределов: $inline$\sqrt{2}, e, \pi$inline$. Первое можно получить как предел последовательности конечных цепных дробей или шагов метода Ньютона, а второе и третье -- в виде последовательности частичных сумм рядов Тэйлора и Лейбница. Все без исключения элементы этих последовательностей рациональны, а их пределы -- нет. И рациональных аналогов этим числам найти не удастся. Таким образом, добавляя к $inline$\mathbb{Q}$inline$ все возможные пределы сходящихся последовательностей из элементов $inline$\mathbb{Q}$inline$, мы пополняем его до чего-то принципиально большего. 

Такое же ключевое свойство, отличает множество $inline$\mathbb{Q}_p$inline$ от сколь угодно больших, но конечных колец $inline$\mathbb{Z}/p^k\mathbb{Z}$inline$, породивших его. Оно включает в себя все пределы сходящихся последовательностей из своих элементов (сходящихся в особом, p-адическом смысле). Это позволяет рассуждать о непрерывности и задействовать ряд методов анализа, основанных на понятиях пределов и производных: метод Ньютона, ряды Тэйлора, а вслед за этим экспоненты, логарифмы, тригонометрию, гамма- и дзета-функцию и прочие инструменты! Все они будут заметно отличаться от своих вещественных аналогов, сохраняя, впрочем, свои главные свойства, и работать смогут не всегда, но их наличие очень важно, когда речь заходит о серьёзной работе с числовыми системами.

Наконец, поле $inline$\mathbb{Q}_p$inline$ можно алгебраически замкнуть, расширив его корнями алгебраических уравнений и преватив в поле p-адических комплексных чисел $inline$\mathbb{C}_p$inline$, а оно уже оказывается изоморфным полю комплексных чисел, построенному на основе вещественных чисел. То есть, наряду со стандартной цепочкой вложений числовых систем:
$$display$$\mathbb{N} \subset \mathbb{Z} \subset \mathbb{Q} \subset \mathbb{R} \subset \mathbb{C},$$display$$ 
можно строить альтернативные цепочки 
$$display$$\mathbb{Z}/p\mathbb{Z} \subset \mathbb{Z}_p \subset \mathbb{Q}_p \subset \mathbb{C}_p \simeq \mathbb{C},$$display$$ которые начинаются с конечных полей вычетов, и достигают алгебраического замыкания, минуя вещественные числа $inline$\mathbb{R}$inline$. Между этими цепочками есть сложные родственные связи: любое кольцо $inline$\mathbb{Z}_p$inline$ включает в себя кольцо $inline$\mathbb{Z}$inline$, а поле $inline$\mathbb{Q}_p$inline$ имеет подполем $inline$\mathbb{Q}$inline$. Однако если мы устремим $inline$p$inline$ к бесконечности, то и $inline$\mathbb{Z}_p$inline$ и $inline$\mathbb{Q}_p$inline$ станут изоморфны $inline$\mathbb{N}$inline$ -- множеству натуральных чисел, вернее, множеству цифр в $inline$\infty$inline$-ичной системе счисления (до второй цифры в каноническом разложении дело так и не дойдёт). 

В середине XX века Александр Островский доказал, что иных путей, ведущих к полным алгебраическими числовым системам не существует. Это значит, что мы перечислили все возможные числовые системы, содержащие *свободное кольцо* (изоморфное кольцу целых чисел), *свободное поле* (изоморфное полю рациональных чисел), а также их *пополнение* и *алгебраическое замыкание*.

Есть ещё один практический аспект, делающий p-адические числа полезным инструментом и за пределами чистой теории чисел. Одна из досадных неприятностей при вычислении чисел в позиционной записи состоит в несимметричности операции переноса -- он всегда делается от младшего разряда к старшему, то есть, справа налево. В этом отношении бесконечный "хвост" цифр, уходящий налево принципиально лучше бесконечного "хвоста", уходящего направо. Ведь переносы приходят именно справа, так что переполнение разряда где-то далеко в бесконечном ряду цифр при любой арифметической операции, может, в принципе, передаваясь по цепочке, повлиять на сколь угодно большой разряд. По существу, каждая цифра, действительного числа, вычислимого в позиционной записи, хранит потенциально бесконечную информацию о всех своих соседях справа. С этим связаны проблемы округления и вытекающая из них неустойчивость вычислительных алгоритмов, а также то, что дробные числа могут иметь два различных позиционнных представления, например, $inline$1/2 = 0.5 = 0.4(9)$inline$. Это значит, что отображение между рациональными числами и их позиционным представлением не биективно, и дело тут уже не в округлении, а гораздо глубже. Это нарушение биективности до сих пор не даёт некоторым математикам (например, Норберту Уайлдбергеру) покоя и они ищут возможность избавиться от него.

В тоже самое время, арифметические действия, выполняемые поразрядно над целыми числами, которые "растут" только влево, не могут повлиять на цифры, которые уже вычислены. Обрывание цепочки где-то далеко слева никак не изменит уже известных нам младших разрядов.

На практике это заключается в следующем. Работая с числами с плавающей точкой, мы постоянно чувствуем конечность разрядности наших вычислительных машин: 

    > 0.2 + 0.1
    0.30000000000000004

Знакомо? При этом неважно с какими числами мы работаем, с большими или маленькими, ошибки округления неизбежны, и, если можно так выразиться, плотно обступают любые числа. В то же самое время, конечность разрядов в целочисленных типах никак не влияет на точность вычислений для чисел, далёких от верхней границы, которая для $inline$64$inline$ или даже $inline$32$inline$ разрядной арифметики уже весьма и весьма велика! Потому так ценятся целочисленные алгоритмы, могущие заменить возню с плавающей точкой. Превращая рациональные числа в p-адические, мы переводим их в область целых чисел, в которой обрывание бесконечной цепочки цифр слева, не затрагивает цифры, уже полученные в более младших разрядах. 

В [этой]() основательной статье, которую я рекомендую всем заинтересовавшимся данной темой, приводится пример вычислительной устойчивости стандартных матричных операций в действительных и в p-адических числах. Вот, например как меняется число верных цифр при обращении матрицы Гильберта, простой, но неприятной матрицы, содержащей простые дроби. В обоих случаях использовалось одинаковое число бит для конечного представления числа.
<table style="width:80%;">
<tbody>
<tr>
<td>Размер матрицы</td>
<td>5</td>
<td>6</td>
<td>7</td>
<td>8</td>
<td>9</td>
<td>10</td>
<td>11</td>
<td>12</td>
<td>13</td>
<td>50</td>
<td>100</td>
</tr>
<tr>
<td>IEEE</td>
<td>40</td>
<td>34</td>
<td>28</td>
<td>25</td>
<td>19</td>
<td>14</td>
<td>9</td>
<td>4</td>
<td>0</td>
<td>–</td>
<td>–</td>
</tr>
<tr>
<td><span class="math display">ℚ<sub>2</sub></span></td>
<td>52</td>
<td>52</td>
<td>51</td>
<td>51</td>
<td>51</td>
<td>51</td>
<td>51</td>
<td>51</td>
<td>51</td>
<td>49</td>
<td>48</td>
</tr>
</tbody>
</table>

Всё это выглядит впечатляюще, но отчего мы до сих пор не отказались от чисел с плавающей точкой и не перешли на 2-адические числа, раз уж мы всё равно используем похожие на них двоичные числа для оцифровывания всего на свете? Всё дело в топологии.

## Почему мы не проходим p-адические числа в школе?

Топология -- это не только про бублики и бутылки Клейна, как может показаться после знакомства с популярными введениями, она про такие свойства пространств и математических объектов, как непрерывность, связность, про их метрические свойства и отношения между объектами, сохраняющие эти свойства. 

Так вот с топологическими свойствами у системы p-адических чисел беда! Их нельзя выстроить по порядку вдоль прямой, как мы привыкли это делать с целыми, рациональными или вещественными числами. Расстояние между двумя p-адическими числами, то есть, абсолютное значение их разности, которое позволяет рассуждать о точности вычислений и о сходимости последовательностей, может быть вычислено единственным способом и он абсолютно не согласуется каким-либо порядком в $inline$\mathbb{R}$inline$. Более того, "между" любыми двумя целыми p-адическими числами можно отыскать сколько угодно других целых p-адических чисел, которые в привычной метрике оказались бы не просто далеко, а бесконечно далеко друг от друга! Впрочем, я взял слово "между" в кавычки, потому что и оно не совсем корректно, ибо p-адические числа топологически размещаются не на каком-то гладком многообразии, а на древо-подобной структуре. При этом пересечение всех открытых интервалов (шаров) образует не континуум, как в топологии действительных чисел, а фрактальное несвязное канторово множество. Впрочем, и сами шары в топологическом p-адическом пространстве весьма странные: любая точка шара, в том числе и граничная, является его центром. Так что мыслить шагами или отрезками на числовой прямой, любо непрерывными перемещениями в пространстве никак не получится, а это очень важная деталь в математической картине физического мира, в котором малому относительному смещению двух точек в пространстве или времени соответствует малое изменение расстояния между ними. В p-адическом мире на это рассчитывать не приходится. 

С чем же связана такая оригинальная топология? Нельзя ли было построить её как-нибудь иначе? Увы, теорема Островского уверждает, что существует только два способа построения нетривиального самосогласованного нормирования для числовых систем, один -- привычный для нас вещественный, а другой -- p-адический. Так что, говоря о p-адических числах совершенно необходимо разобраться как устроено p-адическое метрическое пространство. И в этом нам опять поможет позиционная запись. 

Каким образом мы выясняем близки ли два вещественных числа друг к другу, если они представлены не кучками фасолин или отрезками на прямой, а цифрами? Начиная со старшего разряда мы сравниваем между собой цифры этих двух чисел, и чем длиннее оказывается непрерывная цепочка совпадающих цифр, тем ближе друг к другу они оказываются. Разница между двумя числами  123.456**7**89 и 123.456**6**89  существенно меньше, чем между 1**2**3.456789 и 1**1**3.456789, хотя в обоих случаях отличие состоит в единственной цифре. Всё дело в позиции отличающихся цифр. Разговор о расстоянии между числами проще вести если одно число равно нулю, тогда можно рассуждать об абсолютном значении и нормировании числа (англ. valuation), а для сравнения ненулевых чисел использовать абсолютное значение их разности. В мире вещественных чисел абсолютное значение совпадает с модулем числа. Так, разница между 123.456**7**89 и 123.456**6**89 составляет 0.0001, а между  1**2**3.456789 и 1**1**3.456789 -- 10. Число 0.0001 ближе к нулю чем 10.00.

В сходящихся последовательностях вещественных чисел увеличивается число цифр, совпадающих в левой части числа. Вот, например, как выглядит приближение к числу $inline$\sqrt{2}$inline$ методом Ньютона в вещественных числах:

**1**.0000000000000000
**1**.5000000000000000
**1.41**66666666666665
**1.41421**56862745097
**1.41421356237**46899
**1.4142135623730950**


А теперь перейдём в p-адический мир и перевернём всё задом-наперёд. Числа в каноническом представлении  у нас имеют бесконечный хвост уходящий налево, при этом степень основания продолжает расти как росла, справа налево. Как же сравнивать такие числа? На первом курсе Университета ходила шутка: "Какое число больше $inline$e$inline$ или $inline$\pi$inline$, если читать их с конца?" Так вот, теперь это не шутка, а серьёзный вопрос.

Единственный способ сравнения, который нам остаётся, это такое же сравнение по цифрам, но совпадающие цифры мы можем считать только справа налево, начиная с младшего разряда. Вот, например, как выглядит приближение к тому же $inline$\sqrt{2}$inline$ методом Ньютона, но в $inline$\mathbb{Z}_7$inline$:

…000000000000000000000000000000000000000**4**
…51515151515151515151515151515151515151**54**
…045230045230045230045230045230045230**0454**
…22020100300462442423225230146646**45450454**
…545564125304133412025440**4655400245450454**
…64161633**12301130043502554655400245450454**
…**4026305612301130043502554655400245450454** 

Последовательность, и правда, сходится в p-адическом смысле: с каждым шагом число не меняющихся цифр растёт, но в старших разрядах царит хаос. В пределе мы получим то самое целое число, которое при возведении в квадрат будет в точности равно 2, но путь к нему с точки зрения вещественного порядка будет выглядеть бешеным метанием по числовой оси. Если мы будем рассматривать разности между последовательными членами нашей приближений, то цепочки совпадающих цифры (выделенные жирным), превратятся в постоянно увеличивающуюся цепочку нулей. Именно так выглядит последовательность p-адических чисел, монотонно убывающая по их абсолютному значению. Формально абсолютное значение на $inline$\mathbb{Z}_p$inline$ определяют так: $inline$|x|_p = p^{-k}$inline$, где $inline$k$inline$ -- это число нулей в правой части числа, то есть, позиция младшего ненулевого разряда числа. Элемент $inline$\mathbb{Q}_p$inline$ записывается в общем виде как $inline$x = u \cdot p^v$inline$, при этом обратимый множитель $inline$u$inline$ всегда имеет абсолютное значение равное 1, а $inline$|x|_p = p^{-v}$inline$.

Округление p-адических чисел, таким образом, состоит в обрывании цепочки цифр слева. А благодаря тому, что при арифметических операциях перенос происходит от младшего разряда к старшему, при таком округлении мы не теряем никакой информации. Так что мы можем проводить вычисления с конечными округлёнными представлениями p-адических чисел, но, увы, из-за их патологической топологии мы не сможем ни построить график, ни, как-то вразумительно изобразить эти числа геометрически.

Для чего же они используются на практике? Конечно же, в основном, в теории чисел и абстрактной алгебре, но вот уже более полувека они стали рабочими лошадками в физике (квантовой механике, теории струн), в теории динамических систем и в методах генерации псевдослучайных чисел, в которых корявая p-адическая топология превратилась из бага в фичу.

## Как их правильно готовить

При размышлении о том как реализовать p-адическую алгебру на компьютере, естественным образом возникает искушение представить p-адические числа в каноническом разложении, то есть, как последовательности (списки) цифр, а всю арифметику реализовать поразрядно. Это может быть поучительно, но не эффективно. Мы уже достаточно подкованы теоретически, чтобы понять, что p-адические числа -- это не цепочка цифр, а, в первую очередь, числовая система. В роли системы, представляющей кольцо целых p-адических чисел с ограниченной точностью в $inline$k$inline$ разрядов, может выступать кольцо $inline$\mathbb{Z}/p^k\mathbb{Z}$inline$, содержащее обычные целые числа с обычной модулярной арифметикой. По существу, понижая $inline$\mathbb{Z}_p$inline$ до $inline$\mathbb{Z}/p^k\mathbb{Z}$inline$, мы ограничиваемся лишь первой цифрой канонического разложения в кольце $inline$\mathbb{Z}_{p^k}$inline$. Сложение, вычитание, умножение и деление для первой цифры будет в полной мере соответствовать p-адическим операциям, а так как это просто большое целое число, то оно может быть реализовано очень эффективно, например, с использованием [GMP](http://gmplib.org/) или подобных ей библиотек. Таким образом, на практике стоит рассматривать p-адические числа (и рациональные и трансцедентные) как большие целые, вся арифметика с которыми выполняется по модулю $inline$p^k$inline$.

Первым делом, нужно научиться переходить от вещественных чисел, выраженных с конечной точностью, в $inline$\mathbb{Z}/p^k\mathbb{Z}$inline$ и возвращаться обратно так, чтобы по-возможности, не потерять необходимой информации при этом переходе. 

В нашем контексте точность вещественных чисел определяется не числом значащих цифр десятичного разложения, а максимальными абсолютными значениями для числителя и знаменателя дроби, приближающей вещественные числа. Например, для каких-то вычислений мы можем ограничиться дробями, в которых числитель и знаменатель не превышают $inline$1000$inline$, а для более точных расчетов повысить верхнюю границу для используемых числителей и знаменателей до максимального значения допускаемого типом `Word32` -- $inline$2^{32}$inline$.

## Как их правильно готовить

При размышлении о том как реализовать p-адическую алгебру на компьютере, естественным образом возникает искушение представить p-адические числа в каноническом разложении, то есть, как последовательности (списки) цифр, а всю арифметику реализовать поразрядно. Это может быть поучительно, но не эффективно. Мы уже достаточно подкованы теоретически, чтобы понять, что p-адические числа -- это не цепочка цифр, а, в первую очередь, числовая система. В роли системы, представляющей кольцо целых p-адических чисел с ограниченной точностью в $inline$k$inline$ разрядов, может выступать кольцо $inline$\mathbb{Z}/p^k\mathbb{Z}$inline$, содержащее обычные целые числа с обычной модулярной арифметикой. По существу, понижая $inline$\mathbb{Z}_p$inline$ до $inline$\mathbb{Z}/p^k\mathbb{Z}$inline$, мы ограничиваемся лишь первой цифрой канонического разложения в кольце $inline$\mathbb{Z}_{p^k}$inline$. Сложение, вычитание, умножение и деление для первой цифры будет в полной мере соответствовать p-адическим операциям, а так как это просто большое целое число, то оно может быть реализовано очень эффективно, например, с использованием [GMP](http://gmplib.org/) или подобных ей библиотек. Таким образом, на практике стоит рассматривать p-адические числа (и рациональные и трансцедентные) как большие целые, вся арифметика с которыми выполняется по модулю $inline$p^k$inline$.

Первым делом, нужно научиться переходить от вещественных чисел, выраженных с конечной точностью, в $inline$\mathbb{Z}/p^k\mathbb{Z}$inline$ и возвращаться обратно так, чтобы по-возможности, не потерять необходимой информации при этом переходе. 

В нашем контексте точность вещественных чисел определяется не числом значащих цифр десятичного разложения, а максимальными абсолютными значениями для числителя и знаменателя дроби, приближающей вещественные числа. Например, для каких-то вычислений мы можем ограничиться дробями, в которых числитель и знаменатель не превышают $inline$1000$inline$, а для более точных расчетов повысить верхнюю границу для используемых числителей и знаменателей до максимального значения допускаемого типом `Word32` -- $inline$2^{32}$inline$.

## Как их правильно готовить

При размышлении о том как реализовать p-адическую алгебру на компьютере, естественным образом возникает искушение представить p-адические числа в каноническом разложении, то есть, как последовательности (списки) цифр, а всю арифметику реализовать поразрядно. Это может быть поучительно, но не эффективно. Мы уже достаточно подкованы теоретически, чтобы понять, что p-адические числа -- это не цепочка цифр, а, в первую очередь, числовая система. В роли системы, представляющей кольцо целых p-адических чисел с ограниченной точностью в $inline$k$inline$ разрядов, может выступать кольцо $inline$\mathbb{Z}/p^k\mathbb{Z}$inline$, содержащее обычные целые числа с обычной модулярной арифметикой. По существу, понижая $inline$\mathbb{Z}_p$inline$ до $inline$\mathbb{Z}/p^k\mathbb{Z}$inline$, мы ограничиваемся лишь первой цифрой канонического разложения в кольце $inline$\mathbb{Z}_{p^k}$inline$. Сложение, вычитание, умножение и даже деление для первой цифры будет в полной мере соответствовать p-адическим операциям. А поскольку это просто большое целое число, то арифметика с ним может быть реализована очень эффективно, например, с использованием [GMP](http://gmplib.org/) или подобных ей библиотек. Таким образом, на практике стоит рассматривать p-адические числа (и рациональные и трансцедентные) как большие целые, вся арифметика с которыми выполняется по модулю $inline$p^k$inline$.

Первым делом, нужно научиться переходить от вещественных чисел, выраженных с конечной точностью, в $inline$\mathbb{Z}/p^k\mathbb{Z}$inline$ и возвращаться обратно так, чтобы по-возможности, не потерять необходимой информации при этом переходе. 

В нашем контексте точность вещественных чисел определяется не числом значащих цифр десятичного разложения, а максимальными абсолютными значениями для числителя и знаменателя дроби, приближающей вещественные числа. Например, для каких-то вычислений мы можем ограничиться дробями, в которых числитель и знаменатель не превышают $inline$1000$inline$, а для более точных расчетов повысить верхнюю границу используемых числителей и знаменателей, скажем, до максимального значения допускаемого типом `Word32` -- $inline$2^{32}$inline$.

### Отображение рационального числа в p-адическое

Для перевода числа $inline$x = \frac{r}{s}$inline$ из множества $inline$Q$inline$ в $inline$\mathbb{Z}/p^k\mathbb{Z}$inline$ достаточно найти обратный элемент для $inline$s$inline$ в $inline$\mathbb{Z}/p^k\mathbb{Z}$inline$, то есть элемент $inline$q = s^{-1}$inline$, такой, что $inline$q\cdot s \equiv 1 \mod p^k$inline$. Это сравнение эквивалентно уравнению Безу $inline$s\cdot q + m\cdot p^k = 1$inline$, которое решается расширенным алгоритмом Евклида, еcли $inline$\gcd(s, p) = 1$inline$. 

Вот как выглядит эффективный алгоритм для нахождения округлённого p-адического образа числа $inline$x \in Q$inline$, как элемента $inline$\mathbb{Z}/p^k\mathbb{Z}$inline$:

*Выделяем из числителя или знаменателя множитель $inline$p$inline$, то есть, представляем входное число как произведение $$display$$x = \frac{r}{s}\cdot p^v.$$display$$ Если $inline$\gcd(s, p) = c \neq 1$inline$, то нужно избавиться от делителя $inline$p$inline$ в знаменателе: $$display$$x = \frac{p^{v'}}{p^{v'}} \frac{c^{v'}}{c^{v'}}\frac{r}{s} \cdot p^{v} = \frac{r\cdot (p/c)^{v'}}{s / c^{v'}}\cdot p^{(v-v')}.$$display$$ Полученная дробь будет обратимым элементом в $inline$\mathbb{Z}_p$inline$. Для знаменателя обратимой части находим обратный элемент $inline$q = s^{-1} \mod p^k$inline$, решив уравнение Безу $inline$s\cdot q + m \cdot p^k = 1$inline$ расширенным алгоритмом Евклида или библиотечной функцией, наподобие `mpz_invert` из библиотеки GMP.
Результатом будет p-адическое число с обратимым элементом $inline$u = r\cdot q$inline$ и порядком $inline$v$inline$ .*

<spoiler title="Пример для простого основания">
Найдём образ числа $inline$x = 637/880$inline$ в $inline$\mathbb{Z}_7$inline$ так, чтобы можно было без потери точности восстанавливать числа с числителем и знаменателем, имеющими тип `Word16`.

Найдём необходимую для обеспечения точности степень основания: $$display$$(2^{16})^2 < 7^k / 2 \Longrightarrow k \geq  33\cdot \log_7 2 \approx 12,$$display$$ значит, мы будем работать в кольце вычетов по модулю $inline$7^{12} = 13841287201$inline$ и для хранения любого из элементов этого кольца достаточно будет типа `Word32`.

Выделим из числа степени основания: $inline$x = 7^2\cdot 13/880$inline$, значит, число будет иметь порядок $inline$2$inline$. Найдём обратный элемент для знаменателя: $inline$880^{-1} = 1242570101 \mod 7^{12}$inline$. 
Получаем обратимый элемент p-адического образа:
$$display$$u = 13 \cdot 1242570101 = 2312124112 \mod  7^{12}.$$display$$ и результат $$display$$x = u\cdot 7^2.$$display$$

</spoiler>

<spoiler title="Пример для составного основания">
Найдём образ числа $inline$x = 637/880$inline$ в $inline$\mathbb{Z}_{10}$inline$, с той же степенью округления.

Найдём необходимую для обеспечения точности степень основания: $$display$$(2^{16})^2 < 10^k / 2 \Longrightarrow k \geq  33\cdot \log_{10} 2 \approx 10,$$display$$ значит мы будем работать в кольце вычетов по модулю $inline$10^{10}$inline$ и нам опять хватит типа `Word32` для внутреннего представления.

Выделим из числа степени основания: $inline$x = 10^{-1}\cdot 637/88$inline$. Основание не простое и имеет со знаменателем общий делитель $inline$2$inline$. Значит, дробь нужно преобразовать, избавившись от него. $$display$$x = \frac{637}{88}\cdot 10^{-1} = \frac{(10/2)^3 \cdot 637}{88/ 2^3}\cdot 10^{-1-3} = \frac{5^3 \cdot 637}{11}\cdot 10^{-4}.$$display$$ Найдём обратный элемент для знаменателя $inline$11^{-1} = 9090909091 \mod 10^{10}$inline$ и обратимый элемент p-адического образа $$display$$u = 5^3\cdot 637 \cdot 9090909091 = 3636370875 \mod 10^{10}.$$display$$ Кстати, для этого числа мы сразу можем записать его каноническое разложение: $$display$$x = u \cdot 10^{-4} = ...363637.0875_{10}$$display$$
</spoiler>

### Восстановление рационального числа из p-адического

Как мы уже говорили, из-за того, что множество p-адических чисел существенно больше множества рациональных, корректная реконструкция рационального числа возможна не всегда. При этом особенности p-адической топологии приводят к тому, что постепенное увеличение точности для нерационального p-адического числа не порождает последовательности приближений, сходящейся к какому-то рациональному числу, а работает скорее, как генератор псевдослучайных рациональных чисел. Однако, как в 1981 году показал Пол Ванг, если рациональная реконструкция существует, то она может быть однозначно получена алгоритмом, основанным на расширенном алгоритме Евклида, более известном, как метод Лагранжа для выделения базиса целочисленной решётки. 

Алгоритм восстановления рационального числа $inline$x = \frac{r}{s}, r < N, w < D$inline$ из p-адического числа, округлённого до $inline$k$inline$ разрядов, представленного числом $inline$n \in \mathbb{Z}/p^k\mathbb{Z}$inline$. Необходимое (не не достаточное) условие корректной работы алгоритма: $inline$p^k > 2ND$inline$.

*Инициализируем два вектора $inline$v = (p^k, 0),\ w = (n, 1)$inline$. Пока $inline$w_1 \geq N$inline$ выполняем итерации $$display$$w \to v,\quad  v - \left\lfloor\frac{v_1}{w_1}\right\rfloor w \to w.$$display$$ Если по окончании цикла получаем $inline$w_2 < D$inline$ и $inline$\gcd(w_1, w_2) = 1$inline$, то результатом будет число $inline$x = w_1/w_2$inline$. В противном случае восстановление невозможно, и необходимо увеличивать число разрядов $inline$k$inline$.*

<spoiler title="Пример восстановления">
Восстановим рациональное число $inline$13/880$inline$ по его округлённому представлению $inline$u = 2312124112 \mod  7^{12}$inline$.
Привенение алгоритма породит цепочку итераций для векторов $inline$v$inline$ и $inline$w$inline$:
$$display$$
\begin{array}
{} &v & w \\
{} & (13841287201,0) & (2312124112,1)\\
{} & (2312124112,1) & (2280666641,-5)\\
{} & (2280666641,-5) & (31457471,6) \\
{} & (31457471,6) & (13,880)
\end{array}
$$display$$
</spoiler>

Инструменты для работы с p-адическими числами есть во многих математических пакетах, таких как Sage, Maple, Magma и им подобных, на github выложены библиотеки для многих языков, а теперь такая библиотека есть для Haskell. 




## Пара слов о библиотеке <code>padic</code>

Для Haskell Андреем Лелеченко написан отличный пакет модулярной арифметики [mod](https://hackage.haskell.org/package/mod), с очень удобным интерфейсом и эффективной реализацией. Он и послужил основой для моей библиотеки. Каноническое разложение в список цифр используется только для текстового представления чисел, а вся арифметика производится в целочисленной модулярной арифметике.

Простейшая работа с библиотекой выглядит так:

````hs
> :set -XDataKinds
> 45 :: Z 5
140
> -45 :: Z 5
(4)310
> toInteger it
-45
> 13 / 7 :: Q 10
(714285)9.0
> toRational it
13 % 7
> sqrt 11 :: Q 5
…231012244200433234102330200211.0
> sqrt 11 :: Z' 5 40
…00104441102231221020231012244200433234102330200211.0
> toRational (it ^ 2)
11 % 1
> sin 49 :: Q 7
…013021253020521111000100.0
> fromDigits [1,2,3,0,3,2,1] :: Z 4
1230321
````
Всё достаточно удобно и интуитивно.

Продемонстрируем накопление ошибки округления при работе с IEEE и её отсутствие при работе с 10-адическими числами:

````haskell
> iterate (1 / 3 + ) 0 !! 300000 :: Double
99999.99999968921
> iterate (1 `div` 3 + ) 0 !! 300000 :: Z 10
100000
````
В пакете определено достаточно большое количество функций, алгебраических и трасцедентных, реализован метод Ньютона (в духе леммы Гензеля). Так, например, можно решать алгебраические уравнения: 

````haskell
> henselLifting (\x -> x^3 - 2*x +3) (\x -> 3*x^2 -2) :: [Z 7]
[…106254154414566525205522]
````
Производную надо задавать явно, но можно воспользоваться автоматическим дифферернцированием, которое я не захотел тащить в библиотеку, чтобы не утяжелять её зависимости.

Можно найти 10-адические автоморфные числа и убедиться в том, что в какую бы степень мы их не возвели, они останутся неизменными:
````haskell
> aut = henselLifting (\x -> x^2 - x) (\x -> 2*x - 1) :: [Z 10]
> aut
[0,1,…392256259918212890625,…607743740081787109376]
> and [ x == x^i | x <- aut, i <- [2..200] ]
True
````

А вот ещё числа, которых не встретишь в вещественном мире: n различных корней n-ной степени из единицы, как в комплексных числах (правда, они существуют не для всех n).

````haskell
> unityRoots 3 :: [Q 7]
[1.0,…053116412125443426203642.0,…613550254541223240463024.0]
> (^3) <$> it
[1.0,1.0,1.0]
> unityRoots 6 :: [Q 7]
[1.0,…053116412125443426203642.0,…053116412125443426203643.0,
…613550254541223240463024.0,…613550254541223240463025.0,(6).0]
> (^6) <$> it
[1.0,1.0,1.0,1.0,1.0,1.0]
````

Методом Гензеля можно решать и трансцедентные уравнения тоже. Например, вот 7-адическое число, синус которого равен $inline$7^2$inline$:

````haskell
> x = head $ henselLifting (\x -> sin x - 7^2) cos :: Q 7
> x
…313125366542105556000100.0
> sin x
100.0 -- это 49 в 7-ричном представлении.
````

Из-за особенностей округления в р-адических числах в них можно работать с невероятно большими числами, правда, только с младшими разрядами, наименее значащими в вещественном мире, но в модулярных арифметиках и они способны нести полезную информацию. Например, нам не состоавит особого труда вычислить младшие разряды знаменитого [числа Грэма](https://ru.wikipedia.org/wiki/%D0%A7%D0%B8%D1%81%D0%BB%D0%BE_%D0%93%D1%80%D1%8D%D0%BC%D0%B0). Оно опреляется через т.н. гипероперации -- обобщения арифметических операций. Определим одну из них -- [тетрацию](https://ru.wikipedia.org/wiki/%D0%A2%D0%B5%D1%82%D1%80%D0%B0%D1%86%D0%B8%D1%8F), то есть башню степеней <code>a ^^^ b = a ^ (a ^ (a ... a^a))</code> состоящую из <code>b</code> этажей.

````haskell
(^^^) :: Radix p prec => Z' p prec -> Z' p prec -> Z' p prec 
a ^^^ 0 = 1
a ^^^ 1 = a
a ^^^ b = a `zPow` (a ^^^ (b - 1))
````
Здесь функция <code>zPow</code> -- это p-адическое возведение в степень для кольца целых p-адических чисел. Значение этой функции бысто становятся такими большими, что в обычных вещественных числах с ними уже не поработаешь, тогда как в p-адической арифметике вычисления не занимают сколь-нибудь заметного времени. 

Число Грэма строится на основе тетрации тройки. Нетрудно убедиться, что последовательность $inline$a _i = 3 \text{^^^} i$inline$ сходится в $inline$\mathbb{Z}_10$inline$ к некоторому предельному числу $inline$\mathscr{G}$inline$, которое решает уравнение $inline$3^\mathscr{G} = \mathscr{G}$inline$:

````haskell
> λ> 3 ^^^ 2 :: Z 10
27
λ> 3 ^^^ 3 :: Z 10
7625597484987
λ> 3 ^^^ 4 :: Z 10
…206738945776100739387
λ> 3 ^^^ 5 :: Z 10
…315006939489660355387
λ> 3 ^^^ 6 :: Z 10
…913333445425126595387
λ> 3 ^^^ 10 :: Z 10
…254100942846464195387
λ> 3 ^^^ 100 :: Z 10
…104575627262464195387
λ> g = 3 ^^^ 1000 :: Z 10
…104575627262464195387
````
Существование этого предела означает, что какую бы огромную башню степеней тройки мы бы ни построили (а для числа Грэма она больше чем число планковских расстояний, укладывающихся в диаметр видимой Вселенной), мы получим всего лишь конечное округление числа $inline$\mathscr{G}$inline$! В русскоязычной статье из Википедии приводится 50 младших разрядов числа Грэма. Работая в p-адической арифметике, мы легко можем получить хоть 50, хоть 100 последних цифр этого монстра:

````haskell
> g = 3 ^^^ 1000 :: Z' 10 100
> g
…9404248265018193851562535796399618993967905496638003222348723967018485186439059104575627262464195387
> 3 `zPow` g == g
True
````
## Некоторые детали реализации

Работа над библиотекой <code>padic</code> доставила мне массу удовольствия! 

Особенно приятно, что при реализации этой библиотеки мне удалось задействовать элементы зависимых типов, обеспечив типобезопасность и непредставимость некорректных данных, а таже переведя часть вычислений на этап компиляции. На уровне типов определяется как модуль в котором мы работаем, так и задаваемая точность. Если точность не указана, она подбирается такой, чтобы можно было корректно реконструировать рациональные числа с числителями и знаменателями в пределах типа `Int32` из p-адического представления. На уровне типов так же происходит и согласование модуля p-адического числа $inline$p$inline$ и модуля его внутреннего представления $inline$p^k$inline$ c требуемой точностью. Для этого используются зависимые типы, предоставляемые типами-литералами (type literals) и семействами типов (type families).
<cut />

Типы-литералы, представленные библиотекой [GHC.TypeLits](https://hackage.haskell.org/package/base-4.16.0.0/docs/GHC-TypeLits.html) позволяют оперировать с натуральными числами и со строками на уровне типов. Их можно использовать, как фантомные типы, параметриующие обычные типы данных, к которым, однако, есть доступ в рантайме (только доступ, изменять их можно только на уровне типов). В качестве простого примера их использования создадим минимальный работающий прототип для целочисленной p-адической арифметики.

Начнём с типа <code>Mod p</code>, который добавляет к натуральному числу информацию о том, к какому кольцу вычетов оно относится:

```haskell
{-# LANGUAGE DataKinds #-}
{-# LANGUAGE KindSignatures #-}

import GHC.TypeLits hiding (Mod)

newtype Mod (p :: Nat) = Mod Integer
```

Тип-фантом `p` присутствует только в левой части определения типа-обёртки над типом `Integer`. Его роль только помечать на уровне типов порядок кольца вычетов. Доступ к типу-параметру можно получить с помощью функции `natVal`:

```haskell
> :t natVal
> natVal (Mod 5 :: Mod 10)
10
> :t it
Natural
```
В результате мы получаем "нормальное" натуральное число, с которым можно проводить все возможные вычисления. Например, мы можем определить толковый способ вывода чисел в кольце вычетов на печать:

```haskell
instance KnownNat p => Show (Mod p) where
  show n@(Mod x) = show (x `mod` p) ++ " mod " ++ show p
    where p = natVal n
```
```haskell
> Mod 5 :: Mod 10
5 mod 10
> Mod 17 :: Mod  10
7 mod 10
```
Получить доступ к фантомному типу-параметру можно и у ещё не созданного объекта. Вот, например, как можно реализовать базовый арифметический функционал:

```haskell
instance KnownNat p => Num (Mod p) where
  fromInteger n = let res = Mod $ n `mod` natVal res in res
  Mod a + Mod b = let res = Mod $ (a + b) `mod` natVal res in res
  Mod a - Mod b = let res = Mod $ (a - b) `mod` natVal res in res
  Mod a * Mod b = let res = Mod $ (a * b) `mod` natVal res in res
  negate (Mod a) = let res = Mod (natVal res - a) in res
  abs = id
  signum _ = 1
```
Этот нехитрый приём позволяет нам создавать параметризованные типы из чисел, которые "узнают" о том, в какую модулярную арифметику их погрузили от вызывающей стороны.

```haskell
> 5 :: Mod 3
2 mod 3
> 5 + (14 :: Mod 10)
9 mod 10
```
Корректное представление p-адических чисел подразумевает ряд условий. Во-первых, основание $inline$p$inline$ должно быть числом больше единицы. Во-вторых, внутреннее представление в виде кольца вычетов должно иметь модуль $inline$p^k$inline$, где $inline$k$inline$ должно вычисляться исходя и заданной точности округления p-адических чисел. Всё это можно сделать на уровне типов, используя семейства типов. 

```haskell
-- добавляем к преамбуле
{-# LANGUAGE TypeFamilies #-}
{-# LANGUAGE TypeOperators #-}
{-# LANGUAGE NoStarIsType #-}
{-# LANGUAGE UndecidableInstances #-}

-- добавляем к списку импортов
import Data.Constraint (Constraint)
import Data.Word

-- Ограничение на допустимые значения основания
type family ValidRadix (m :: Nat) :: Constraint where
  ValidRadix 0 = TypeError ('Text "Zero radix!")
  ValidRadix 1 = TypeError ('Text "Radix should be more then 1!")
  ValidRadix m = ()

-- Основание для внутреннего представления p-адического числа
type family LiftedRadix p prec where
  LiftedRadix p prec = p ^ (2*prec + 1)

-- Ограничение для основания p-адического числа с точностью prec
type family Radix p prec :: Constraint where
  Radix p prec =
    ( KnownNat prec
    , KnownNat p, ValidRadix p
    , KnownNat (LiftedRadix p prec), ValidRadix (LiftedRadix p prec) )

-- Точность, необходимая для восстановления рациональных чисел 
-- с числителем и знаменателем, принадлежащим  типу num
type family SufficientPrecision num (p :: Nat) :: Nat where
  SufficientPrecision Word32 2 = 64
  SufficientPrecision Word32 3 = 43
  SufficientPrecision Word32 5 = 30
  SufficientPrecision Word32 6 = 26
  SufficientPrecision Word32 7 = 24
  SufficientPrecision t p = Div (SufficientPrecision t 2) (Log2 p)
```
Эти условия и ограничения позволяют нам определить тип для целых p-адических чисел

```haskell
-- добавляем в преамбулу
{-# LANGUAGE DerivingVia #-}
{-# LANGUAGE StandaloneDeriving #-}

newtype Z' (p :: Nat) (prec :: Nat) = Z' (R prec p)
newtype R (prec :: Nat ) (p :: Nat) = R (Mod (LiftedRadix p prec))
type Z p = Z' p (SufficientPrecision Word32 p)

deriving via (Mod p) instance Radix p prec => Num (R p prec)
deriving via (Mod (LiftedRadix p prec)) instance Radix p prec => Num (R p prec)
```
Чехарда с двумя вложенными типами `Z` и `R` понадобилась для того, чтобы обеспечить доступ к обоим фантомным типам, при том, что функция `natVal` способна "считать" только внешний тип-фантом.

```haskell
precision :: (Radix p prec, Z' p prec, Integral i) => Z' p prec -> i
precision z = fromIntegral (natVal z)

radix :: (Radix p prec, Z' p prec, Integral i) => Z' p prec -> i
radix (Z' r) = fromIntegral (natVal r)
```
На этапе компиляции все эти типы-обертки исчезнут так что в результирующем коде останутся только операции над числами типа `Integer` заточенные для работы с p-адическими числами.
Осталось только сделать так, чтобы p-адические числа  выводились в своей системе счисления. Для этого напишем примитивную реализацию метода `show`:

```haskell
instance Radix p prec => Show (Z' p prec) where
  show n@(Z' (R (Mod x))) = 
  foldMap show $ reverse $ take (precision n) $ toRadix (radix n) x

toRadix :: Integer -> Integer -> [Int]
toRadix _ 0 = [0]
toRadix p n = unfoldr go n
  where
    go 0 = Nothing
    go x = let (q, r) = quotRem x p in Just (fromIntegral r, q)
```
```haskell
> 42 :: Z 5
132

-- посмотрим на внутреннее представление этого числа
> Z' (R x) = 42 :: Z' 5 10
> x
42 mod 476837158203125
> Z' (R x) = 42 :: Z' 5 5
> x
42 mod 48828125

-- работа с отрицательными числами:
> -42 :: Z 5
444444444444444444444444444313
> -42 :: Z' 5 5
44313
> (-42 :: Z 5) + 52
20

-- получим последовательность, сходящуюся к автоморфному числу
> mapM_ print $ take 10 $ iterate (^2) (5 :: Z' 10 10)
5
25
625
390625
2587890625
6962890625
5712890625
3212890625
8212890625
8212890625
```

По большому счёту, того, что мы сделали, уже достаточно для реализации простейшей p-адической арифметики. Для полноценной работы нужно ещё реализовать корректные переходы от рациональных чисел к p-адическим и обратно, а также многие другие функции. Те, кому интересны, эти детали, могут посмотреть код [библиотеки](https://github.com/samsergey/padic.html) на GitHub.
