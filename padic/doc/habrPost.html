&lt;!DOCTYPE html&gt;
<html>
<head>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<h1 id="p-адические-числа-и-их-реализация-на-haskell">p-адические числа и их реализация на Haskell</h1>
<p>Сегодня я предлагаю заглянуть в один любопытный уголок теории чисел, в котором обитают p-адические числа, а попутно познакомить с некоторыми классными инструментами в системе типов Haskell – с типами-литералами и семействами типов. Есть опасения, что статья, рассказывающая о нескольких неочевидных вещах сразу, будет чересчур сложной, но мне кажется, что смысл рискнуть, всё же, есть. Рассказывая об абстрактных математических концепциях, хорошо иметь перед собой практические примеры их работы, а для “объяснения” этих абстракций компьютеру, бывают полезны специальные “педагогические” приёмы.</p>
<p>Я люблю язык Haskell оттого, что начиная с какого-то времени мне стало комфортно на нём думать. Это, конечно, дело вкуса и опыта, но многое в языке помогает в этом. Во-первых, он функционален и декларативен, а значит, алгоритмы, легко превращать в определения и наоборот. Во вторых, его система типов позволяет поднять размышления о том, что же ты делаешь на новый уровень осознанности, так что алгоритмы, являющиеся по существу, числодробилками, на Haskell таковыми не выглядят.</p>
<p>Оказалось, что в репозитории <a href="https://hackage.haskell.org/">hackage</a>, основном для Haskell-сообщества, нет библиотеки для работы с p-адическими числами, даже в таких серьёзных теоретико-числовых библиотеках, как <a href="https://hackage.haskell.org/package/arithmetic">arithmetic</a>, <a href="https://hackage.haskell.org/package/arithmoi">arithmoi</a> или <a href="https://hackage.haskell.org/package/factory">factory</a>. Я написал и опубликовал свой модуль padic, и расскажу о некоторых деталях его реализации.</p>
<p>В арсенале профессионалов и настоящих мастеров подчас попадаются странные инструменты. Не сразу можно сказать для чего они нужны и как они, вообще, могут быть полезными. Но при решении каких-то особенных задач они оказываются незаменимыми. Начиная с какого-то уровня погружения в теорию чисел, алгебраическую геометрию, квантовую механику или теорию струн, авторы книг и статей зачастую переходят от привычных целых и вещественных чисел к p-адическим числам и при этом удивительным образом чувствуют, что им становится легче. По По крайней мере у меня, первое знакомство с ними ощущения лёгкости не создало. В сети достаточно много вводных материалов по этой теме, как виде книг, статей и блогов, так и в форме видео. В конце этой статьи я приведу ссылки на материалы, показавшиеся мне особенно интересными и полезными. Большинство из этих введений начинается с определения p-адической нормы, а завершается упоминанием фрактальной (канторовой) топологии, которую эти числа образуют. При этом приводится пара канонических примеров необычности этой числовой системы, таких как сходимость суммы всех положительных степеней двойки к минус единице или возможность получить целочисленные квадратные корни из 2, 5 или 7. В более серьёзных книгах всё внезапно становится существенно более сложным, поскольку вдруг авторам становится важно не то как складывать и умножать эти числа, а то что они образуют проективный предел колец вычетов относительно естественных проекций или что образуемое ими метрическое пространство неархимедово. Это похоже на ситуацию с многочисленными введениями в монады, ну, вы понимаете о чём я… Поэтому мы сегодня постараемся, отталкиваясь от простой арифметики, пройти несколько дальше и понять в чём практический смысл введения этих числовых монстров.</p>
<h2 id="начинаем-с-цифр">Начинаем с цифр</h2>
<p>Что мы имеем в виду, когда записываем число рядом цифр? – То, что его можно представить в виде взвешенной суммы степеней некоторого основания, натурального числа, не равного нулю или единице. Обычно мы работаем с основанием 10, равным числу пальцев на руках, в “цифровом” мире повсеместно используется самое маленькое из возможных основание 2, ну, а при записи времени нам оказалось удобным использовать смешанную систему с основаниями 12 и 60. В позиционной записи числа цифры выбираются из конечного множества возможных остатков деления на основание, а позиция цифры в ряду, обозначающем число, соответствует степени основания. Это всё привычно и поэтому кажется простым. Более того, в повседневности мы складываем и вычитаем, умножаем и делим, а также сравниваем не числа, а их позиционную запись (расширенную знаком “минус” для отрицательных чисел), а это значит, мы рассчитываем на то, что множество чисел и множество их позиционных представлений “работают” одинаково. Если мы выберем в качестве представления числа не цепочки цифр, а какие-то количественные меры, например, шаги на бесконечной ленте, то результаты сложения “в столбик по цифрам” и непосредственно по шагам на этой ленте будут согласованы. Это же относится и к другим операциям и свойствам. Говоря на языке математики, мы рассчитываем на изоморфизм между двумя числовыми системами: системой целых чисел и системой, которое образуют последовательности цифр вместе со знакомыми нам со школы операциями поразрядного сложения, вычитания и умножения. Более того, цифры при выполнении этих операций тоже ведут себя как элементы числовой системы – системы вычетов по модулю выбранного основания. Это значит, что цифры тоже можно складывать, вычитать и умножать, но по правилам модулярной арифметики, у которой тоже есть хорошо знакомый нам “нецифровой” аналог: шаги по замкнутой ленте.</p>
<p>Далее я буду использовать математические имена и обозначения для этих числовых систем. Система целых чисел (изоморфная шагам по бесконечной в обе стороны ленте) является <a href="https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%BC%D0%BC%D1%83%D1%82%D0%B0%D1%82%D0%B8%D0%B2%D0%BD%D0%BE%D0%B5_%D0%BA%D0%BE%D0%BB%D1%8C%D1%86%D0%BE">кольцом</a> и обозначается <span class="math display">ℤ</span>. Цифры, используемые при записи числа в позиционной записи с основанием <span class="math display"><em>b</em></span> образуют <a href="https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%BB%D1%8C%D1%86%D0%BE_%D0%B2%D1%8B%D1%87%D0%B5%D1%82%D0%BE%D0%B2">кольцо вычетов</a> по модулю <span class="math display"><em>m</em></span>, которое мы будем обозначать как <span class="math display">ℤ/<em>m</em>ℤ</span>. Эта система изоморфна шагам по замкнутой ленте, вмещающей ровно <span class="math display"><em>m</em></span> ячеек или отметок.</p>
<p>В кольце можно складывать, вычитать и перемножать любые элементы, оставаясь в этом же кольце. А вот деление возможно не всегда, например, в кольце <span class="math display">ℤ</span> нет такого элемента, который был бы равен <span class="math display">2/3</span>, то есть, решал бы уравнение <span class="math display">3<em>x</em> = 2</span>. Для того, чтобы можно было делить на любой ненулевой элемент, кольцо <span class="math display">ℤ</span> расширяется до <a href="https://ru.wikipedia.org/wiki/%D0%9F%D0%BE%D0%BB%D0%B5_(%D0%B0%D0%BB%D0%B3%D0%B5%D0%B1%D1%80%D0%B0)">поля</a> рациональных чисел <strong>Q</strong>.</p>
<p>Кольца вычетов конечны, и может показаться, что их возможности меньше бесконечного кольца целых чисел, но это не так. В них, даже в совсем небольших, можно обнаружить то, чего нет в целых числах. Например, в кольце <span class="math display">ℤ/5ℤ</span> из пяти элементов <span class="math display">{0, 1, 2, 3, 4}</span> у каждого элемента есть противоположный, то есть такой, что в сумме они дают ноль. То есть, в этом смысле оно включает в себя “отрицательные числа”: <span class="math display">1 =  − 4, 2 =  − 3, 3 =  − 2, 4 =  − 1</span>. Более того, в этой системе у любого корректного линейного уравнения есть решение, то есть, у каждого ненулевого элемента есть обратный, такой, что их произведение равно еднице. То есть, оно содержит все возможные формальные дроби: <span class="math display">1 = 1/4 = 3/2, 2 = 1/3 = 3/4, 3 = 1/2 = 4/3, 4 = 2/3</span>. Значит, это уже не только кольцо, но и поле. Каждое кольцо вычетов по модулю, являющемуся простым числом, образует поле.</p>
<p>Но это ещё не все “сокровища”. В кольце <span class="math display">ℤ/5ℤ</span> есть то, чего нет ни в целых, ни в рациональных числах, а именно <span class="math display">$$\sqrt{-1}$$</span>, ведь <span class="math display">2<sup>2</sup> = 4 =  − 1</span>. Это вовсе не значит, что 2 это мнимая единица, просто уравнение <span class="math display"><em>x</em><sup>2</sup> + 1 = 0</span> решается в этом кольце. Кольца вычетов разные и у каждого есть свои интересные особенности, например, в кольце привычных нам цифр <span class="math display">ℤ/10ℤ</span> нет всех возможных дробей, но зато в нём есть делители нуля, то есть, такие ненулевые числа, которые в произведении дают 0. А ещё в нём есть числа, равные своим квадратам: это 5 и 6 (помните рифмы в таблице умножения: “пятью-пять – двадцать пять, шесть-шесть – тридцать шесть”? В кольце десятичных цифр нас интересуют только последние цифры результатов.). Таким образом, уравнение <span class="math display"><em>x</em>(<em>x</em>−1) = 0</span> имеет в этом кольце целых четыре различных корня из которых два нетривиальны!</p>
<h2 id="поднимаемся-выше">Поднимаемся выше</h2>
<p>Кольца вычетов разные, но каждое из них порождает целое семейство потомков, которым они передают часть своих особенностей, но каждый из которых способен пойти дальше своего родителя. Потомками кольца <span class="math display">ℤ/<em>m</em>ℤ</span> можно считать кольца <span class="math display">ℤ/<em>m</em><sup>2</sup>ℤ</span>, <span class="math display">ℤ/<em>m</em><sup>3</sup>ℤ</span> и т.д. Рассмотрим, например, кольцо <span class="math display">ℤ/25ℤ</span>. В нём тоже есть все “отрицательные числа” и большая часть дробей (кроме тех, что имеют знаменатель, кратный 5). Имеется в нём и <span class="math display">$$\sqrt{-1} = \pm7$$</span>, а также появляются корни из <span class="math display"> ± 6</span> и <span class="math display"> ± 11</span>, которых не могло быть в <span class="math display">ℤ/5ℤ</span>. В кольце <span class="math inline">ℤ/125ℤ</span> остаётся всё то же, что было у потомков, но расширяется набор квадратных уравнений, имеющих решения и появляется возможность решать некоторые кубические уравнения.</p>
<p>А интересно, если продолжать наращивать степени и новые возможности, то какими свойствами будет обладать кольцо <span class="math display">ℤ/5<sup>∞</sup>ℤ</span>? На этот вопрос и ответил Курт Гензель, определив для такого предельного кольца числовую систему и описав его свойства. Система <span class="math display">ℤ/<em>p</em><sup>∞</sup>ℤ</span>, порождаемая кольцом вычетов <span class="math display">ℤ/<em>p</em>ℤ</span> называется системой целых p-адических чисел и обозначается <span class="math display">ℤ<sub><em>p</em></sub></span>. Она включает в себя всех своих родителей, как подкольца и обладает всеми их свойствами сразу! Однако при устремлении к бесконечности количество переходит в качество и мы получаем нечто новое: бесконечное кольцо, которое включает в себя в качестве подкольца все <span class="math display">ℤ</span> целиком, но кроме того, содержит все формальные дроби со знаменателями, не кратными основанию <span class="math display"><em>p</em></span> и решения широкого класса алгебраических уравнений линейных, квадратных и высших степеней! Не любых, конечно, а только тех, что решаются в кольцах-родителях, но это “не баг, а фича”, поскольку позволяет относительно легко определить существует ли решение у заданного алгебраического уравнения, что в целых или рациональных числах представляет крайне сложную задачу. Достаточно вспомнить, Великую теорему Ферма о существовании решения уравнения <span class="math display"><em>x</em><sup><em>n</em></sup> + <em>y</em><sup><em>n</em></sup> =  = <em>z</em><sup><em>n</em></sup></span> в целых числах, на доказательство которой ушло три столетия, и не удивительно, что в том доказательстве, что представил Энрю Уайлз, используются p-адические числа.</p>
<p>Но это ещё не всё, что можно построить “поднимая” кольца вычетов до предельных колец целых p-адических чисел. Запрет на дроби со знаменателем, кратным основанию <span class="math inline"><em>p</em></span>, достаточно жестко ограничивает нас в выборе доступных математических инструментов. Его можно изящно обойти, если рассмотреть произведение <span class="math display"><em>u</em> ⋅ <em>p</em><sup><em>v</em></sup>, <em>u</em> ∈ ℤ<sub><em>p</em></sub>, <em>v</em> ∈ ℤ</span>. В ней число <span class="math display"><em>u</em></span> – обратимое целое p-адическое число (для которого всегда можно вычислить <span class="math display"><em>u</em><sup>−1</sup></span>), а второе – показатель степени при основании <span class="math display"><em>p</em></span>. Таким образом, рассматривая числа <span class="math display"><em>y</em><sub>1</sub> = <em>u</em><sub>1</sub> ⋅ <em>p</em><sup><em>v</em><sub>1</sub></sup></span> и <span class="math display"><em>y</em><sub>2</sub> = <em>u</em><sub>2</sub> ⋅ <em>p</em><sup><em>v</em><sub>2</sub></sup></span>, мы всегда сможем найти их отношение <span class="math display">$$\frac{y_1}{y_2} = \frac{u_1}{u_2}\cdot p^{v1-v2}$$</span>. Это позволяет нам дополнить кольцо целых чисел <span class="math display">ℤ<sub><em>p</em></sub></span> до поля рациональных чисел <span class="math display">ℚ<sub><em>p</em></sub></span>. Если <span class="math display"><em>p</em></span> – простое число, то у нас этот трюк точно получится, поскольку в этом случае кольцо <span class="math display">ℤ/<em>p</em>ℤ</span> не содержит делителей нуля, а все делители нуля у потомков обязаны содерать в себе в качестве множителя <span class="math display"><em>p</em></span>. Но все такие множители мы вынесли в выражение <span class="math display"><em>p</em><sup><em>v</em></sup></span>, а значит, любое число <span class="math display"><em>u</em></span> будет обратимым.</p>
<p>Итак, несложный трюк, хорошо знакомый всем компьютерщикам и физикам (подобный разделению числа на мантиссу и порядок, только не в степенях десяти, а в степенях основания) помог нам повысить статус p-адических чисел до полноценного поля, которое теперь включает в себя в качестве подкольца целиком все кольцо целых чисел <span class="math display">ℤ</span>, в качесте подполя целиком всё поле рациональных чисел <span class="math display">ℚ</span>, а помимо них бесконечное множество других элементов, решающих алгебраические уравнения!</p>
<p>Конечные поля вычетов (алгебра простых цифр), которые лежат в основе p-адических чисел, существенно проще для анализа чем натуральные числа. Там, конечно, тоже хватает технических трудностей, но к ним проще подступиться потому, хотя бы, что поля эти конечны. Очень многие общие результаты теории чисел и алгебраической геометрии могут быть получены переходом к 2-адическим числам, которые, как мы теперь понимаем, можно рассматривать как бесконечноразрядные двоичные дроби.</p>
<p>Но, возникает вопрос: откуда же взялись все эти дополнительные числа? Описанный нами процесс повышения степени колец вычетов <span class="math display">ℤ/<em>p</em>ℤ → ℤ/<em>p</em><sup>2</sup>ℤ → ℤ/<em>p</em><sup>2</sup>ℤ → ...</span> всё время расширял кольца новыми <strong>целыми числами</strong>, принадлежащими кольцам <span class="math display">ℤ/<em>p</em><sup><em>k</em></sup>ℤ</span>. Все наши формальные дроби и квадратные корни всегда совпадали с какми-то целыми числами и были от них неотличимы. Значит ли это, что и в <span class="math display">ℤ<sub><em>p</em></sub></span> дроби и алгебраические корни тоже будут какими-то целыми числами, совпадающими с “нормальными”. И да и нет. Да – они все будут целыми, нет – они все будут отличаться и друг от друга и от элементов подкольца <span class="math display">ℤ<sub><em>p</em></sub></span>. Тут работает магия предельного перехода.</p>
<h2 id="возвращаемся-к-цифрам">Возвращаемся к цифрам</h2>
<p>Что мы делаем, когда хотим выразить сложную мысль? – используем много букв. А если нужно выразить большое целое число? – тогда нужно использовать много цифр и позиционную запись. С помощью привычной нам позиционной системы счисления можно выражать и p-адические числа. Начём опять с маленького кольца <span class="math display">ℤ/5ℤ</span>. Все его элементы принадлежат множеству цифр <span class="math display">{0, 1, 2, 3, 4}</span>. Поднимемся на ступень выше и перейдём в кольцо <span class="math display">ℤ/25ℤ</span>. Можно каждому элементу этого кольца назначить свой символ, скажем, из английского алфавита, а можно воспользоваться тем, что в этом кольце ровно <span class="math display">5 × 5</span> элементов, ни больше ни меньше, а значит каждому из них можно поставить в соответствие пару цифр, и таких пар будет в точности <span class="math display">5<sup>2</sup></span>. Это соответствие можно сделать не каким попало, а естественным, то есть таким, которое сможет сохранить числовые свойства цифр и элементов <span class="math display">ℤ/25ℤ</span>. Для этого достаточно использовать принципы позиционной записи, представив число <span class="math display"><em>x</em></span> из <span class="math display">ℤ/25ℤ</span> как сумму <span class="math display">5<em>b</em> + <em>a</em></span> используя цифры <span class="math display"><em>a</em>, <em>b</em> ∈ ℤ/5ℤ</span>. Получим хорошо знакомую пятиричную систему счисления, которая позволяет подниматься по степеням основания, повышая разрядность записи числа. Так для записи любого числа из <span class="math display">ℤ/5<sup><em>k</em></sup>ℤ</span> потребуется цепочка из <span class="math display"><em>k</em></span> пятиричных цифр.</p>
<p>Самое главное достоинство такого представления состоит в изоморфизме между числами и их позиционном представлении, о котором говорилось в самом начале статьи. Благодаря ему арифметические операции, производимые поразрядно (сложение с переносом, вычитание с “заниманием”, умножение “в столбик” и деление “уголком”) согласуются с арифметикой чисел, представляемых цепочкой цифр. А это значит, что совершая предельный переход от конечных колец к бесконечному, мы возможность записывать 5-адическое число с помощью бесконечной цепочки пятиричных цифр: <span class="math display">$$$ x = \overline{...fedcba}_5 = ... 5^5 f + 5^4 e +  5^3 d + 5^2 c +  5 b + a,$$</span>$ и автоматом получаем практическую арифметику для p-адических чисел, знакомую со школьной скамьи! Такая запись называется <em>каноническим разложением p-адического</em> числа.</p>
<p>И как только число цифр устремилось к бесконечночти, у нас и появляется куча свободного места для дополнительных чисел. Все целые числа записываются конечным числом цифр. Задумайтесь над этим, множество целых чисел не ограничено сверху, однако сколь бы большое число вы ни выбрали (хоть знаменитое число Грэма, хоть его факториал) оно всегда может быть представлено <em>конечным</em> числом цифр. Таким образом, любое целое число можно представить как p-адическое, добавив бесконечную цепочку нулей после старшего разряда. Но p-адические числа могут иметь и любые ненулевые числа в своём бесконечном хвосте, который по нашему определению бесконечно длинее любого конечного начала. Таким образом, множество p-адических много больше множества целых! Настолько же, насколько иррациональных чисел больше чем рациональных. Бесконечное разнообразие бесконечных последовательностей из конечного набора цифр образует континуум!</p>
<p>Добавляя степень основания для перехода к рациональным p-адическим числам, мы вводим аналог десятичной точки, которая разделяет p-адическое число в каноническом разложении на конечную дробную и бесконечную целую части. Давайте посмотрим на примеры некоторых p-адических чисел:</p>
<p><span class="math display">$$\begin{align*}
123 &amp;= 123_{10}\\
123 &amp;= 11120_3\\
-123 &amp;= …9999999999999999999999877_{10} = (9)877_{10} = (4)002_5\\
1/123 &amp;= …69918699186991869918699187_{10} = (69918)7_{10}\\
-\frac{1}{49} &amp;= …66666666666666666666666666666.66_7 = (6).66_7 \\
3/171 &amp;= (7\,12\,10\,0\,5\,12\,1\,1\,10\,9\,4\,7\,3\,11\,5\,3\,2\,6)\,8_{13}\\
0.1234 = \frac{617}{500} &amp;= 0.1234_{10}\\
\frac{617}{500}\cdot\frac1{17} &amp;= …294117647058823529411764705882.3602_{10}\\
\sqrt 17 &amp;= …110110000011111110000010000001_2\\
\sqrt{-1} &amp;= …141421404340423140223032431212_5\\
\end{align*}
$$</span></p>
<p>В каноническом p-адическом разложении целые числа записываются в виде конечной последовательности цифр (бесконечную цепочку нулей, уходящую налево при записи опускают). Отрицательные целые числа вместо бесконечной цепочки нулей слева имеют бесконечную последовательность наибольшей из цифр. В p-адическом разложении цифры рациональных чисел после какой-то конечной цепочки всегда приходят к периодической последовательности. Обратите внимание на то, что запись числа 0.1234 в десятичной дроби и в виде 10-адического числа совпадают, это не случайно и достаточно удобно: положительные целые и дробные числа с конечным числом цифр имеют одинаковые десятичное и 10-адическое представление.</p>
<h2 id="какая-от-них-польза">Какая от них польза?</h2>
<p>Если долго смотреть на бесконечный хвост, уходящий влево, становится не по себе, ведь чем левее цифра, тем старше разряд, то есть, тем больше число. Получается, что почти все p-адические числа в обиходном смысле “бесконечны”. Впрочем, “бесконечных” чисел в математике не существует, смысла в них немного. Как же вопринимать числа, записываемые заведомо бесконечным числом разрядов? В некотором смысле, так же, как и числа с бесконечным числом разрядов, но только уходящих направо от десятичной запятой, как в десятичных дробях, к ним-то мы привыкли! Вполне безобидное конечное число 1/3 имеет в десятичной позиционной системе бесконечную последовательность цифр <span class="math display">0.33333333... = 0.(3)</span>, так же как и в 10-адической: <span class="math display">...66666667 = (6)7<sub>10</sub></span>. Множество рациональных чисел в десятичной записи тоже включает в себя все натуральные числа, как такое подмножество, у которого справа от десятичной точки начинается бесконечная цепочка нулей. При этом большая часть вещественных чисел, образующих континуум, может быть записана только в виде бесконечной последовательности ненулевых цифр. Так что же, целые p-адические числа это как p-ричные дроби, записанные наоборот? Простая формальность? Нет, это не так, они круче!</p>
<p>Множество вещественных чисел <span class="math display">ℝ</span> включает в себя множество рациональных <span class="math display">ℚ</span>, но кроме него <span class="math display">ℝ</span> содержит в себя все пределы фундаментальных последовательностей, сходящихся в <span class="math display">ℚ</span>, но не ему принадлежащих. Классические примеры таких пределов: <span class="math display">$$\sqrt{2}, e, \pi$$</span>. Первое можно получить как предел последовательности конечных цепных дробей или шагов метода Ньютона, а второе и третье – в виде последовательности частичных сумм рядов Тэйлора и Лейбница. Все без исключения элементы этих последовательностей рациональны, а их пределы – нет. Таким образом, добавляя к <span class="math display">ℚ</span> все возможные пределы сходящихся последовательностей из элементов <span class="math display">ℚ</span>, мы пополняем его до <span class="math display">ℝ</span>. В целых числах тоже можно строить бесконечные последовательности, и можно даже говорить об их сходимости, если, начиная с какого-то шага все члены последовательности будут равны нулю. Мы используем это свойство <span class="math display">ℤ</span> во многих целочисленных алгоритмах, как сигнал к завершению вычислений, например, в алгоритме Евклида для поиска наибольшего общего делителя.</p>
<p>Ключевое свойство множества <span class="math display">ℚ<sub><em>p</em></sub></span>, отличающее его от сколь угодно больших, но конечных колец <span class="math display">ℤ/<em>p</em><sup><em>k</em></sup>ℤ</span> породивших его, состоит в том, что оно включает в себя все пределы сходящихся последовательностей из своих элементов (сходящихся в особом, p-адическом смысле). Это позволяет рассуждать о непрерывности и задействовать ряд методов анализа, использующие понятия пределов и производных, метод Ньютона, ряды Тэйлора, а вслед за этим экспоненты, логарифмы, тригонометрию, гамма- и дзета-функцию и прочие инструменты! Все они будут заметно отличаться от своих вещественных аналогов, сохраняя, впрочем, свои главные свойства, и работать смогут не всегда, но их наличие очень важно, когда речь заходит о серьёзной работе с числовыми системами.</p>
<p>Наконец, поле <span class="math display">ℚ<sub><em>p</em></sub></span> можно алгебраически замкнуть, расширив его корнями алгебраических уравнений и преватив в поле p-адических комплексных чисел <span class="math display">ℂ<sub><em>p</em></sub></span>, которое уже оказывается изоморфным полю комплексных чисел, построенному на основе вещественных чисел. То есть, наряду со стандартной цепочкой вложений числовых систем: <span class="math display">ℤ ⊂ ℚ ⊂ ℝ ⊂ ℂ</span>, можно строить альтернативные цепочки <span class="math display">ℤ/<em>p</em>ℤ ⊂ ℤ<sub><em>p</em></sub> ⊂ ℚ<sub><em>p</em></sub> ⊂ ℂ<sub><em>p</em></sub> ≃ ℂ</span>, которые начинаются с конечных полей вычетов, и достигают алгебраического замыкания, минуя вещественные числа <span class="math display">ℝ</span>. Между этими альтернативными цепочками есть сложные родственные связи: любое кольцо <span class="math display">ℤ<sub><em>p</em></sub></span> включает в себя кольцо <span class="math display">ℤ</span>, а поле <span class="math display">ℚ<sub><em>p</em></sub></span> имеет подполем <span class="math display">ℚ</span>. Однако если мы устремим <span class="math display"><em>p</em></span> к бесконечности, и <span class="math display">ℤ<sub><em>p</em></sub></span> и <span class="math display">ℚ<sub><em>p</em></sub></span> превратятся… в <span class="math display">ℕ</span> – во множество натуральных чисел, представляющее множество цифр в <span class="math display">∞</span>-ичной системе счисления (до второй цифры в разложении дело так и не дойдёт). Но это уже сплетни не имеющие какого-то практического смысла.</p>
<p>В середине XX века Александр Островский доказал, что иных путей, ведущих к полным алгебраическими числовым системам не существует. Это значит, что мы перечислили все возможные числовые системы, содержащие свободное кольцо (изоморфное кольцу целых чисел), свободное поле (изоморфное полю рациональные чисел), а также их пополнение и алгебраическое замыкание.</p>
<p>Есть ещё один практический аспект, деающий p-адические числа полезным инструментом и за пределами чистой теории чисел. Одна из досадных неприятностей при вычислении чисел в позиционной записи состоит в несимметричности операции переноса – он всегда делается от младшего разряда к старшему, то есть, справа налево. В этом отношении бесконечный “хвост” цифр, уходящий налево принципиально лучше бесконечного “хвоста”, уходящего направо. Ведь переносы переходят именно справа, так что переполнение разряда где-то далеко в бесконечном ряду цифр при любой арифметической операции, может, в принципе, передаваясь по цепочке, повлиять на сколь угодно большой разряд. По существу, каждая цифра, действительного числа, вычислимого в позиционной записи, хранит потенциально бесконечную информацию о всех своих соседях справа. С этим связаны проблемы округления и вытекающая из них неустойчивость вычислительных алгоритмов, а также то, что дробные числа могут иметь два эквивалентных позиционнных представления, например, <span class="math display">123/20 = 6.15 = 6.14(9)</span>. В тоже самое время, арифметические действия, выполняемые поразрядно над целыми числами, которые “растут” только влево не могут повлиять на цифры, которые уже вычислены. Обрывание цепочки где-то далеко слева никак не изменит уже известных нам младших разрядов.</p>
<p>На практике это заключается в следующем. Работая с числами с плавающей точкой, мы постоянно чувствуем конечность разрядности наших вычислительных машин: 0.2 + 0.1 ==&gt; 0.30000000000000004, знакомо? При этом неважно с какими числами мы работаем, с большими или маленькими, ошибки округления, если можно так выразиться, плотно обступают любые числа. В то же самое время, конечность разрядов в целочисленных типах никак не влияет на точность вычислений для чисел, далёких от верхней границы, которая для 64 или даже 32 разрядной арифметики уже весьма и весьма велика! Потому так ценятся целочисленные алгоритмы, могущие заменить возню с плавающей точкой. Превращая рациональные числа в p-адические, мы переводим их в область целых чисел, в которой обрывание бесконечной цепочки цифр слева, не затрагивает цифры, уже полученные в более младших разрядах.</p>
<p>В <a href="">этой</a> основательной статье, которую я рекомендую всем заинтересовавшимся данной темой, приводится пример вычислительной устойчивости стандартных матричных операций в действительных и в p-адических числах. Вот, например как меняется число верных цифр при обращении матрицы Гильберта, простой, но неприятной матрицы, содержащей простые дроби. В обоих случаях использовалось одинаковое число бит для конечного представления числа.</p>
<table style="width:100%;">
<colgroup>
<col style="width: 24%" />
<col style="width: 6%" />
<col style="width: 6%" />
<col style="width: 6%" />
<col style="width: 6%" />
<col style="width: 6%" />
<col style="width: 6%" />
<col style="width: 6%" />
<col style="width: 6%" />
<col style="width: 6%" />
<col style="width: 6%" />
<col style="width: 6%" />
</colgroup>
<tbody>
<tr class="odd">
<td>Размер матрицы</td>
<td>5</td>
<td>6</td>
<td>7</td>
<td>8</td>
<td>9</td>
<td>10</td>
<td>11</td>
<td>12</td>
<td>13</td>
<td>50</td>
<td>100</td>
</tr>
<tr class="even">
<td>IEEE</td>
<td>40</td>
<td>34</td>
<td>28</td>
<td>25</td>
<td>19</td>
<td>14</td>
<td>9</td>
<td>4</td>
<td>0</td>
<td>–</td>
<td>–</td>
</tr>
<tr class="odd">
<td><span class="math display">ℚ<sub>2</sub></span></td>
<td>52</td>
<td>52</td>
<td>51</td>
<td>51</td>
<td>51</td>
<td>51</td>
<td>51</td>
<td>51</td>
<td>51</td>
<td>49</td>
<td>48</td>
</tr>
</tbody>
</table>
<p>Всё это выглядит впечатляюще, но отчего мы до сих пор не отказались от чисел с плавающей точкой и не перешли на 2-адические числа, раз уж мы всё равно используем похожие на них двоичные числа для оцифровывания всего на свете? Всё дело в топологии.</p>
<h2 id="почему-мы-не-проходим-p-адические-числа-в-школе">Почему мы не проходим p-адические числа в школе?</h2>
<p>Топология – это не только про бублики и бутылки Клейна, как может показаться после знакомства с популярными введениями, она про такие свойства пространств и математических объектов, как непрерывность, связность, про их метрические свойства и отношения между объуктами, сохраняющие эти свойства. Так вот с топологическими свойствами у системы p-адических чисел беда! Их нельзя выстроить по порядку вдоль прямой, как мы привыкли это делать с целыми, рациональными или вещественными числами. Расстояние между двумя p-адическими числами, то есть, абсолютное значение их разности, которое позволяет рассуждать о точности вычислений и о сходимости последовательностей, может быть вычислено единственным способом и он абсолютно не согласуется каким-либо порядком в <span class="math display">ℝ</span>. Более того, “между” любыми двумя целыми p-адическими числами можно отыскать сколько угодно других целых p-адических чисел, которые в привычной метрике оказались бы не просто далеко, а бесконечно далеко друг от друга! Впрочем, я взял слово “между” в кавычки, потому что и оно не совсем корректно, ибо p-адические числа топологически размещаются не на каком-то гладком многообразии, а на древо-подобной структуре. При этом пересечение всех открытых интервалов (шаров) образует не континуум, как в топологии действительных чисел, а фрактальное несвязное канторово множество пример которого показан на рисунке в заголовке статьи. Впрочем, и сами шары в топологическом p-адическом пространстве весьма странные: любая точка шара, в том числе и граничная, является его центром. Так что мыслить шагами или отрезками на числовой прямой, любо непрерывными перемещениями в пространстве никак не получится, а это очень важная деталь в математической картине физического мира, в котором малому относительному смещению двух точек в пространстве или времени соответствует малое изменение расстояния между ними. В p-адическом мире на это рассчитывать не приходится.</p>
<p>С чем же связана такая оригинальная топология? Нельзя ли было построить её как-нибудь иначе? Увы, теорема Островского уверждает, что существует только два способа построения нетривиальных самосогласованных абсолютных значений для числовых систем, одна привычная для нас – вещественная, а другая – p-адическая. Так что, говоря о p-адических числах совершенно необходимо разобраться в p-адической метрике.</p>
<p>Каким образом мы выясняем близки ли два вещественных числа друг к другу, если они представлены в позиционной системе? Начиная со старшего разряда мы сравниваем между собой цифры этих двух чисел, и чем длиннее оказывается непрерывная цепочка совпадающих цифр, тем ближе друг к другу они оказываются. Разница между двумя числами 123.456<strong>7</strong>89 и 123.456<strong>6</strong>89 существенно меньше, чем между 1<strong>2</strong>3.456789 и 1<strong>1</strong>3.456789, хотя в обоих случаях отличие состоит в единственной цифре. Всё дело в позиции отличающихся цифр. Разговор о расстоянии между числами проще вести если одно число равно нулю, тогда можно рассуждать об абсолютном значении и нормировании числа (valuation по-английски), а для сравнения ненулевых чисел использовать абсолютное значение их разности. В мире вещественных чисел абсолютное значение совпадает с модулем числа. Так, разница между 123.456<strong>7</strong>89 и 123.456<strong>6</strong>89 составляет 0.0001, а между 1<strong>2</strong>3.456789 и 1<strong>1</strong>3.456789 – 10. Число 0.00001 ближе к нулю чем 0.02, поскольку цепочка из четырёх нулей после десятичной точки больше цепочки из одного нуля.</p>
<p>В сходящихся последовательностях вещественных чисел увеличивается число цифр, совпадающих в левой части числа. Вот, например, как выглядит приближение к числу <span class="math display">$$\sqrt{2}$$</span> методом Ньютона:</p>
<pre><code>1.0000000000000000
1.5000000000000000
1.4166666666666665
1.4142156862745097
1.4142135623746899
1.4142135623730950</code></pre>
<p>А теперь перейдём в p-адический мир и перевернём всё задом-наперёд. Числа у нас имеют бесконечный хвост уходящий налево, при этом степень основания продолжает расти как росла, в том же направлении! Как сравнивать такие числа? На первом курсе Университета ходила шутка: “Какое число больше <span class="math display"><em>e</em></span> или <span class="math display"><em>π</em></span>, если читать их с конца?” Так вот, теперь это не шутка, а серьёзный вопрос.</p>
<p>Единственный способ сравнения, который нам остаётся, это такое же сравнение по цифрам, но совпадающие цифры мы можем считать только справа налево, начиная с младшего разряда. Вот, например, как выглядит приближение к тому же <span class="math display">$$\sqrt{2}$$</span> методом Ньютона, но в <span class="math display">ℤ<sub>7</sub></span>:</p>
<pre><code>…000000000000000000000000000000000000000&lt;b&gt;4&lt;/b&gt;
…5151515151515151515151515151515151515154
…0452300452300452300452300452300452300454
…2202010030046244242322523014664645450454
…5455641253041334120254404655400245450454
…6416163312301130043502554655400245450454
…4026305612301130043502554655400245450454 </code></pre>
<p>Последовательность, и правда, сходится в p-адическом смысле: с каждым шагом число не меняющихся цифр растёт, но в старших разрядах царит хаос. В пределе мы получим то самое целое число, которое при возведении в квадрат будет в точности равно 2, но путь к нему с точки зрения вещественного порядка будет выглядеть бешеным метанием по числовой оси. Если мы будем рассматривать разности между последовательными членами нашей приближений, то цепочки совпадающих цифры (выделенные жирным), превратятся в постоянно увеличивающуюся цепочку нулей. Именно так выглядит последовательность p-адических чисел, монотонно убывающая по их абсолютному значению. Формально абсолютное значение на <span class="math display">ℤ<sub><em>p</em></sub></span> определяют так: <span class="math display">|<em>x</em>|<sub><em>p</em></sub> = <em>p</em><sup>−<em>k</em></sup></span>, где <span class="math display"><em>k</em></span> – это число нулей в правой части числа, то есть, позиция младшего ненулевого разряда числа. Элемент <span class="math display">ℚ<sub><em>p</em></sub></span> записывается в общем виде как <span class="math display"><em>x</em> = <em>u</em> ⋅ <em>p</em><sup><em>v</em></sup></span>, при этом обратимый множитель <span class="math display"><em>u</em></span> всегда имеет абсолютное значение равное 1, а <span class="math display">|<em>x</em>|<sub><em>p</em></sub> = <em>p</em><sup>−<em>v</em></sup></span>.</p>
<p>Округление p-адических чисел, таким образом, состоит в обрывании цепочки цифр слева. А благодаря тому, что при арифметических операциях перенос происходит от младшего разряда к старшему, при таком округлении мы не теряем никакой информации. Так что мы можем проводить вычисления с конечными округлёнными представлениями p-адических чисел, но, увы, из-за их патологической топологии мы не сможем ни построить график, ни, как-то вразумительно изобразить эти числа геометрически.</p>
<p>Для чего же они используются на практике? Конечно же, в основном, в теории чисел и абстрактной алгебре, но вот уже более полувека они стали рабочими лошадками в физике (квантовой механике, теории струн), в теории динамических систем и в методах генерации псевдослучайных чисел, в которых корявая p-адическая топология превратилась из бага в фичу.</p>
<p>Инструменты для работы с p-адическими числами есть во многих математических пакетах, таких как Sage, Maple, Magma и им подобных, на github выложены библиотеки для многих языков, а теперь такая библиотека есть для Haskell.</p>
<h2 id="пара-слов-о-библиотеке-padic">Пара слов о библиотеке <code>padic</code></h2>
<p>Для практического использования p-адических чисел нужно уметь переходить к ним от вещественных чисел, выраженных с конечной точностью, и возвращаться обратно так, чтобы не потерять согласованности между арифметиками и точностями в этих системах.</p>
<p>Естественным образом возникает искушение представить p-адические числа как последовательности (списки) цифр, и всю арифметику реализовать поразрядно, “в столбик”. Это поучительно, но не эффективно. Мы уже достаточно теоретически подготовлены, чтобы понять, что в роли кольца целых p-адических чисел с ограниченной точностью в <span class="math display"><em>k</em></span> разрядов может выступать кольцо <span class="math display">ℤ/<em>p</em><sup><em>k</em></sup>ℤ</span>, содержащее целые числа с обычной модулярной арифметикой. Сложение, вычитание, умножение и деление в этом кольце будет соответствовать p-адическим операциям и может быть реализовано очень эффективно с использованием <a href="http://gmplib.org/">GMP</a> или подобных ей библиотек. Для Haskell Андреем Лелеченко написан отличный пакет модулярной арифметики <a href="https://hackage.haskell.org/package/mod">mod</a>, с очень удобным интерфейсом и эффективной реализацией. Он и послужил основой для моей библиотеки. “Дорогое” разложение в виде списка цифр используется только для текстового представления чисел, вся арифметика производится в целочисленной модулярной арифметике.</p>
<p>Простейшая работа с библиотекой выглядит так:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="op">:</span>set <span class="op">-</span><span class="dt">XDataKinds</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="dv">45</span><span class="ot"> ::</span> <span class="dt">Z</span> <span class="dv">5</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="dv">140</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="op">-</span><span class="dv">45</span><span class="ot"> ::</span> <span class="dt">Z</span> <span class="dv">5</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>(<span class="dv">4</span>)<span class="dv">310</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="fu">toInteger</span> it</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="op">-</span><span class="dv">45</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="fu">sqrt</span> <span class="dv">11</span><span class="ot"> ::</span> <span class="dt">Q</span> <span class="dv">5</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>…<span class="fl">231012244200433234102330200211.0</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="fu">sqrt</span> <span class="dv">2</span><span class="ot"> ::</span> <span class="dt">Z&#39;</span> <span class="dv">5</span> <span class="dv">40</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>…<span class="fl">00104441102231221020231012244200433234102330200211.0</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="fu">sin</span> <span class="dv">49</span><span class="ot"> ::</span> <span class="dt">Q</span> <span class="dv">7</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>…<span class="fl">013021253020521111000100.0</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="dv">13</span> <span class="op">/</span> <span class="dv">7</span><span class="ot"> ::</span> <span class="dt">Q</span> <span class="dv">10</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>(<span class="dv">714285</span>)<span class="fl">9.0</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="fu">toRational</span> it</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="dv">13</span> <span class="op">%</span> <span class="dv">7</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> fromDigits [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>]<span class="ot"> ::</span> <span class="dt">Z</span> <span class="dv">4</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="dv">1230321</span></span></code></pre></div>
<p>Всё достаточно удобно и интуитивно. На уровне типов определяется как модуль в котором мы работаем, так и задаваемая точность. Если точность не указана, она подбирается такой, чтобы можно было корректно реконструировать рациональные числа с числителями и знаменателями в пределах типа <code>Int32</code> из p-адического представления. На уровне типов так же происходит и согласование модуля p-адического числа <span class="math display"><em>p</em></span> и модуля его внутреннего представления <span class="math display"><em>p</em><sup><em>k</em></sup></span> c требуемой точностью. Для этого используются зависимые типы, предоставляемые типами-литералами (type literals) и семействами типов (type families).</p>
</html>
