<!DOCTYPE html><html><head><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script></head>

# p-адические числа и их реализация на Haskell

Сегодня я предлагаю заглянуть в один любопытный уголок теории чисел, в котором обитают необычные создания -- p-адические числа, а попутно познакомиться с двумя классными инструментами в системе типов Haskell, с типами-литералами и семействами типов. Есть опасения, что статья, рассказывающая о нескольких неочевидных вещах сразу, будет чересчур сложной, но мне кажется, что смысл рискнуть, всё же, есть. Рассказывая об абстрактных математических концепциях, хорошо иметь перед собой практические примеры их работы, а для "объяснения" этих абстракций компьютеру, бывают полезны специальные "педагогические" приёмы.

Я люблю язык Haskell оттого, что начиная с какого-то времени мне стало комфортно на нём думать. Это, конечно, дело вкуса и опыта, но многое в языке помогает в этом. Во-первых, он функционален и декларативен, а значит, алгоритмы, легко превращать в определения и наоборот. Во вторых, его система типов позволяет поднять размышления о том, что же ты делаешь на новый уровень осознанности, так что алгоритмы, являющиеся по существу, числодробилками, на Haskell таковыми не выглядят.

Оказалось, что в репозитории [hackage](https://hackage.haskell.org/), основном для Haskell-сообщества, нет библиотеки для работы с p-адическими числами, даже в таких серьёзных теоретико-числовых библиотеках, как [arithmetic](https://hackage.haskell.org/package/arithmetic), [arithmoi](https://hackage.haskell.org/package/arithmoi) или [factory](https://hackage.haskell.org/package/factory). Я написал и опубликовал свой модуль padic, и расскажу о некоторых деталях его реализации.

В арсенале профессионалов и настоящих мастеров подчас попадаются странные инструменты. Не сразу можно сказать для чего они нужны и как они, вообще, могут быть полезными. Но при решении каких-то особенных задач они оказываются незаменимыми. Начиная с какого-то уровня погружения в теорию чисел, алгебраическую геометрию, квантовую механику или теорию струн, авторы книг и статей зачастую переходят от привычных целых и вещественных чисел к p-адическим числам и при этом удивительным образом чувствуют, что им становится легче. По По крайней мере у меня, первое знакомство с ними ощущения лёгкости не создало. В сети достаточно много вводных материалов по этой теме, как виде книг, статей и блогов, так и в форме видео. В конце этой статьи я приведу ссылки на материалы, показавшиеся мне особенно интересными и полезными. Большинство из этих введений начинается с определения p-адической нормы, а завершается упоминанием фрактальной (канторовой) топологии, которую эти числа образуют. При этом приводится пара канонических примеров необычности этой числовой системы, таких как сходимость суммы всех положительных степеней двойки к минус единице или возможность получить целочисленные квадратные корни из 2, 5 или 7. В более серьёзных книгах всё внезапно становится существенно более сложным, поскольку вдруг авторам становится важно не то как складывать и умножать эти числа, а то что они образуют проективный предел колец вычетов относительно естественных проекций или что образуемое ими метрическое пространство неархимедово. Это похоже на ситуацию с многочисленными введениями в монады, ну, вы понимаете о чём я... Поэтому мы сегодня постараемся, отталкиваясь от простой арифметики, пройти несколько дальше и понять в чём практический смысл введения этих числовых монстров.


## Начинаем с цифр

Что мы имеем в виду, когда записываем число рядом цифр? -- То, что его можно  представить в виде взвешенной суммы степеней некоторого основания, натурального числа, не равного нулю или единице. Обычно мы работаем с основанием 10, равным числу пальцев на руках, в "цифровом" мире повсеместно используется самое маленькое из возможных основание 2, ну, а при записи времени нам оказалось удобным использовать смешанную систему с основаниями 12 и 60. В позиционной записи числа цифры выбираются из конечного множества возможных остатков деления на основание, а позиция цифры в ряду, обозначающем число, соответствует степени основания. Это всё привычно и поэтому кажется простым. Более того, в повседневности мы складываем и вычитаем, умножаем и делим, а также сравниваем не числа, а их позиционную запись (расширенную знаком "минус" для отрицательных чисел), а это значит, мы рассчитываем на то, что множество чисел и множество их позиционных представлений "работают" одинаково. Если мы выберем в качестве представления числа не цепочки цифр, а какие-то количественные меры, например, шаги на бесконечной ленте, то результаты сложения "в столбик по цифрам" и непосредственно по шагам на этой ленте будут согласованы. Это же относится и к другим операциям и свойствам. Говоря на языке математики, мы рассчитываем на изоморфизм между двумя числовыми системами: системой целых чисел и системой, которое образуют последовательности цифр вместе со знакомыми нам со школы операциями поразрядного сложения, вычитания и умножения. Более того, цифры при выполнении этих операций тоже ведут себя как элементы числовой системы -- системы вычетов по модулю выбранного основания. Это значит, что цифры тоже можно складывать, вычитать и умножать, но по правилам модулярной арифметики, у которой тоже есть хорошо знакомый нам "нецифровой" аналог: шаги по замкнутой ленте.

Далее я буду использовать математические имена и обозначения для этих числовых систем. Система целых чисел (изоморфная шагам по бесконечной в обе стороны ленте) является [кольцом](https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%BC%D0%BC%D1%83%D1%82%D0%B0%D1%82%D0%B8%D0%B2%D0%BD%D0%BE%D0%B5_%D0%BA%D0%BE%D0%BB%D1%8C%D1%86%D0%BE) и обозначается  $$\mathbb{Z}$$. Цифры, используемые при записи числа в позиционной записи с основанием $$b$$ образуют [кольцо вычетов](https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%BB%D1%8C%D1%86%D0%BE_%D0%B2%D1%8B%D1%87%D0%B5%D1%82%D0%BE%D0%B2) по модулю $$m$$, которое мы будем обозначать как $$\mathbb{Z}/m\mathbb{Z}$$. Эта система изоморфна шагам по замкнутой ленте, вмещающей ровно $$m$$ ячеек или отметок. 

В кольце можно складывать, вычитать и перемножать любые элементы, оставаясь в этом же кольце. А вот деление возможно не всегда, например, в кольце $$\mathbb{Z}$$ нет такого элемента, который был бы равен $$2/3$$, то есть, решал бы уравнение $$3x=2$$. Для того, чтобы можно было делить на любой ненулевой элемент, кольцо $$\mathbb{Z}$$ расширяется до [поля](https://ru.wikipedia.org/wiki/%D0%9F%D0%BE%D0%BB%D0%B5_(%D0%B0%D0%BB%D0%B3%D0%B5%D0%B1%D1%80%D0%B0)) рациональных чисел **Q**.

Кольца вычетов конечны, и может показаться, что их возможности меньше бесконечного кольца целых чисел, но это не так. В них, даже в совсем небольших, можно обнаружить то, чего нет в целых числах. Например, в кольце $$\mathbb{Z}/5\mathbb{Z}$$ из пяти элементов $$\{0,1,2,3,4\}$$ у каждого элемента есть противоположный, то есть такой, что в сумме они дают ноль. То есть, в этом смысле оно включает в себя "отрицательные числа": $$1 = -4, 2 = -3, 3 = -2, 4 = -1$$. Более того, в этой системе у любого корректного линейного уравнения есть решение, то есть, у каждого ненулевого элемента есть обратный, такой, что их произведение равно еднице. То есть, оно содержит все возможные формальные дроби: $$1 = 1/4 = 3/2, 2 = 1/3 = 3/4, 3 = 1/2 = 4/3, 4 = 2/3$$. Значит, это уже не только кольцо, но и поле. Каждое кольцо вычетов по модулю, являющемуся простым числом, образует поле.

Но это ещё не все "сокровища". В кольце $$\mathbb{Z}/5\mathbb{Z}$$ есть то, чего нет ни в целых, ни в рациональных числах, а именно $$\sqrt{-1}$$, ведь $$2^2 = 4 = -1$$. Это вовсе не значит, что 2 это мнимая единица, просто уравнение $$x^2 + 1 = 0$$ решается в этом кольце. Кольца вычетов разные и у каждого есть свои интересные особенности, например, в кольце привычных нам цифр $$\mathbb{Z}/10\mathbb{Z}$$ нет всех возможных дробей, но зато в нём есть делители нуля, то есть, такие ненулевые числа, которые в произведении дают 0. А ещё в нём есть числа, равные своим квадратам: это 5 и 6 (помните рифмы в таблице умножения: "пятью-пять -- двадцать пять, шесть-шесть -- тридцать шесть"? В кольце десятичных цифр нас интересуют только последние цифры результатов.). Таким образом, уравнение $$x(x-1) = 0$$ имеет в этом кольце целых четыре различных корня из которых два нетривиальны! 

## Поднимаемся выше

Кольца вычетов разные, но каждое из них порождает целое семейство потомков, которым они передают часть своих особенностей, но каждый из которых способен пойти дальше своего родителя. Потомками кольца $$\mathbb{Z}/m\mathbb{Z}$$ можно считать кольца $$\mathbb{Z}/m^2\mathbb{Z}$$, $$\mathbb{Z}/m^3\mathbb{Z}$$ и т.д. Рассмотрим, например, кольцо $$\mathbb{Z}/25\mathbb{Z}$$. В нём тоже есть все "отрицательные числа" и большая часть дробей (кроме тех, что имеют знаменатель, кратный 5). Имеется в нём и $$\sqrt{-1} = \pm7$$, а также появляются корни из $$\pm6$$ и $$\pm11$$, которых не могло быть в $$\mathbb{Z}/5\mathbb{Z}$$. В кольце $\mathbb{Z}/125\mathbb{Z}$ остаётся всё то же, что было у потомков, но расширяется набор квадратных уравнений, имеющих решения и появляется возможность решать некоторые кубические уравнения. 

А интересно, если продолжать наращивать степени и новые возможности, то какими свойствами будет обладать кольцо $$\mathbb{Z}/5^\infty\mathbb{Z}$$? На этот вопрос и ответил Курт Гензель, определив для такого предельного кольца числовую систему и описав его свойства. Система $$\mathbb{Z}/p^\infty\mathbb{Z}$$, порождаемая кольцом вычетов $$\mathbb{Z}/p\mathbb{Z}$$ называется системой целых p-адических чисел и обозначается $$\mathbb{Z}_p$$. Она включает в себя всех своих родителей, как подкольца и обладает всеми их свойствами сразу! Однако при устремлении к бесконечности количество переходит в качество и мы получаем нечто новое: бесконечное кольцо, которое включает в себя в качестве подкольца все $$\mathbb{Z}$$ целиком, но кроме того, содержит все формальные дроби со знаменателями, не кратными основанию $$p$$ и решения широкого класса алгебраических уравнений линейных, квадратных и высших степеней! Не любых, конечно, а только тех, что решаются в кольцах-родителях, но это "не баг, а фича", поскольку позволяет относительно легко определить существует ли решение у заданного алгебраического уравнения, что в целых или рациональных числах представляет крайне сложную задачу. Достаточно вспомнить, Великую теорему Ферма о существовании решения уравнения $$x^n + y^n == z^n$$ в целых числах, на доказательство которой ушло три столетия, и не удивительно, что в том доказательстве, что представил Энрю Уайлз, используются p-адические числа. 

Но это ещё не всё, что можно построить "поднимая" кольца вычетов до предельных колец целых p-адических чисел. Запрет на дроби со знаменателем, кратным основанию $p$, достаточно жестко ограничивает нас в выборе доступных математических инструментов. Его можно изящно обойти, если рассмотреть произведение $$u \cdot p^v, u \in \mathbb{Z}_p, v \in \mathbb{Z}$$. В ней число $$u$$ -- обратимое целое p-адическое число (для которого всегда можно вычислить $$u^{-1}$$), а второе -- показатель степени при основании $$p$$. Таким образом, рассматривая числа $$y_1 = u_1 \cdot p^{v_1}$$ и $$y_2 = u_2 \cdot p^{v_2}$$, мы всегда сможем найти их отношение $$\frac{y_1}{y_2} = \frac{u_1}{u_2}\cdot p^{v1-v2}$$. Это позволяет нам дополнить кольцо целых чисел $$\mathbb{Z}_p$$ до поля рациональных чисел $$\mathbb{Q}_p$$. Если $$p$$ -- простое число, то у нас этот трюк точно получится, поскольку в этом случае кольцо $$\mathbb{Z}/p\mathbb{Z}$$ не содержит делителей нуля, которые обязаны в случае простого $$p$$ содерать в себе его в качестве множителя. Однако все такие множители мы вынесли в выражение $$p^v$$, а значит, любое число $$u$$ будет обратимым. 

При работе с позиционными системами счисления выгодно в качестве основания выбирать число с большим количеством множителей. Число 10 в этом отношении, хуже чем 12, 24 или 60. Всё эти числа используются человечеством, как основания с древнейших времён. Однако для работы с p-адическими числами такие основания хуже простых. Так что часто в самом начале статей и книг сразу оговаривают, что число $$p$$ в p-адической системе -- простое.

Итак, несложный трюк, хорошо знакомый всем компьютерщикам и физикам (подобный разделению числа на мантиссу и порядок, только не в степенях десяти, а в степенях основания) помог нам повысить статус p-адических чисел до полноценного поля, которое теперь включает в себя в качестве подкольца целиком *всё кольцо целых чисел* $$\mathbb{Z}$$, а в качесте подполя целиком *всё поле рациональных чисел* $$\mathbb{Q}$$, а помимо них бесконечное множество других элементов, решающих алгебраические уравнения! 

Конечные поля вычетов (алгебра простых цифр), которые лежат в основе p-адических чисел, существенно проще для анализа чем натуральные числа. Там, конечно, тоже хватает технических трудностей, но к ним проще подступиться потому, хотя бы, что поля эти конечны. Очень многие общие результаты теории чисел и алгебраической геометрии могут быть получены переходом к 2-адическим числам, которые, как мы теперь понимаем, можно рассматривать как бесконечноразрядные двоичные дроби.

Но, возникает вопрос: откуда же взялись все эти дополнительные числа? Описанный нами процесс повышения степени колец вычетов $$\mathbb{Z}/p\mathbb{Z} \to \mathbb{Z}/p^2\mathbb{Z} \to \mathbb{Z}/p^2\mathbb{Z} \to ...$$ всё время расширял кольца новыми **целыми числами**, принадлежащими кольцам $$\mathbb{Z}/p^k\mathbb{Z}$$. Все наши формальные дроби и квадратные корни всегда совпадали с какми-то целыми числами и были от них неотличимы. Значит ли это, что и в $$\mathbb{Z}_p$$ дроби и алгебраические корни тоже будут какими-то целыми числами, совпадающими с "нормальными". И да и нет. Да -- они все будут целыми, нет -- они все будут отличаться и друг от друга и от элементов подкольца $$\mathbb{Z}_p$$. Тут работает магия предельного перехода.

## Возвращаемся к цифрам

Что мы делаем, когда хотим выразить сложную мысль? -- используем много букв. А если нужно выразить большое целое число? -- тогда нужно использовать много цифр и позиционную запись. С помощью привычной нам позиционной системы счисления можно выражать и p-адические числа. Начём опять с маленького кольца $$\mathbb{Z}/5\mathbb{Z}$$. Все его элементы принадлежат множеству цифр $$\{0,1,2,3,4\}$$. Поднимемся на ступень выше и перейдём в кольцо $$\mathbb{Z}/25\mathbb{Z}$$. Можно каждому элементу этого кольца назначить свой символ, скажем, из английского алфавита, а можно воспользоваться тем, что в этом кольце ровно $$5 \times 5$$ элементов, ни больше ни меньше, а значит каждому из них можно поставить в соответствие пару цифр, и таких пар будет в точности $$5^2$$. Это соответствие можно сделать не каким попало, а естественным, то есть таким, которое сможет сохранить числовые свойства цифр и элементов $$\mathbb{Z}/25\mathbb{Z}$$. Для этого достаточно использовать принципы позиционной записи, представив число $$x$$ из $$\mathbb{Z}/25\mathbb{Z}$$ как сумму $$5b + a$$ используя цифры $$a, b \in \mathbb{Z}/5\mathbb{Z}$$. Получим хорошо знакомую пятиричную систему счисления, которая позволяет подниматься по степеням основания, повышая разрядность записи числа. Так для записи любого числа из $$\mathbb{Z}/5^k\mathbb{Z}$$ потребуется цепочка из $$k$$ пятиричных цифр. 

Самое главное достоинство такого представления состоит в изоморфизме между числами и их позиционном представлении, о котором говорилось в самом начале статьи. Благодаря ему арифметические операции, производимые поразрядно (сложение с переносом, вычитание с "заниманием", умножение "в столбик" и деление "уголком") согласуются с арифметикой чисел, представляемых цепочкой цифр. А это значит, что совершая предельный переход от конечных колец к бесконечному, мы возможность записывать 5-адическое число с помощью бесконечной цепочки пятиричных цифр: 
$$$ x = \overline{...fedcba}_5 = ... 5^5 f + 5^4 e +  5^3 d + 5^2 c +  5 b + a,$$$ и автоматом получаем практическую арифметику для p-адических чисел, знакомую со школьной скамьи! Такая запись называется *каноническим разложением p-адического* числа.

И как только число цифр устремилось к бесконечночти, у нас и появляется куча свободного места для дополнительных чисел. Все целые числа записываются конечным числом цифр. Задумайтесь над этим, множество целых чисел не ограничено сверху, однако сколь бы большое число вы ни выбрали (хоть знаменитое число Грэма, хоть его факториал) оно всегда может быть представлено *конечным* числом цифр. Таким образом, любое целое число можно представить как p-адическое, добавив бесконечную цепочку нулей после старшего разряда. Но p-адические числа могут иметь и любые ненулевые числа в своём бесконечном хвосте, который по нашему определению  бесконечно длинее любого конечного начала. Таким образом, множество p-адических много больше множества целых! Настолько же, насколько иррациональных чисел больше чем рациональных. Бесконечное разнообразие бесконечных последовательностей из конечного набора цифр образует континуум!

Добавляя степень основания для перехода к рациональным p-адическим числам, мы вводим аналог десятичной точки, которая разделяет p-адическое число в каноническом разложении на конечную дробную и бесконечную целую части. Давайте посмотрим на примеры некоторых p-адических чисел:

$display$\begin{align*}
123 &= 123_{10}\\
123 &= 11120_3\\
-123 &= …9999999999999999999999877_{10} = (9)877_{10} = (4)002_5\\
1/123 &= …69918699186991869918699187_{10} = (69918)7_{10}\\
-\frac{1}{49} &= …66666666666666666666666666666.66_7 = (6).66_7 \\
3/171 &= (7\,12\,10\,0\,5\,12\,1\,1\,10\,9\,4\,7\,3\,11\,5\,3\,2\,6)\,8_{13}\\
0.1234 = \frac{617}{500} &= 0.1234_{10}\\
\frac{617}{500}\cdot\frac1{17} &= …294117647058823529411764705882.3602_{10}\\
\sqrt 17 &= …110110000011111110000010000001_2\\
\sqrt{-1} &= …141421404340423140223032431212_5\\
\end{align*}
$display$

В каноническом p-адическом разложении целые числа записываются в виде конечной последовательности цифр (бесконечную цепочку нулей, уходящую налево при записи опускают). Отрицательные целые числа вместо бесконечной цепочки нулей слева имеют бесконечную последовательность наибольшей из цифр. В p-адическом разложении цифры рациональных чисел после какой-то конечной цепочки всегда приходят к периодической последовательности. Обратите внимание на то, что запись числа 0.1234 в десятичной дроби и в виде 10-адического числа совпадают, это не случайно и достаточно удобно: положительные целые и дробные числа с конечным числом цифр имеют одинаковые десятичное и 10-адическое представление.


## Какая от них польза?

Если долго смотреть на бесконечный хвост, уходящий влево, становится не по себе, ведь чем левее цифра, тем старше разряд, то есть, тем больше число. Получается, что почти все p-адические числа в обиходном смысле "бесконечны". Впрочем, "бесконечных" чисел в математике не существует, смысла в них немного. Как же вопринимать числа, записываемые заведомо бесконечным числом разрядов? В некотором смысле, так же, как и числа с бесконечным числом разрядов, но только уходящих направо от десятичной запятой, как в десятичных дробях, к ним-то мы привыкли! Вполне безобидное конечное число 1/3 имеет в десятичной позиционной системе бесконечную последовательность цифр $$0.33333333... = 0.(3)$$, так же как и в 10-адической: $$...66666667 = (6)7_{10}$$. Множество рациональных чисел в десятичной записи тоже включает в себя все натуральные числа, как такое подмножество, у которого справа от десятичной точки начинается бесконечная цепочка нулей. При этом большая часть вещественных чисел, образующих континуум, может быть записана только в виде бесконечной последовательности ненулевых цифр. Так что же, целые p-адические числа это как p-ричные дроби, записанные наоборот? Простая формальность? Нет, это не так, они круче!

Во некоторых популярных введениях p-адические числа презентуют, как "бесконечноразрядные числа", или как оригинальный способ записывать числа "в обратном порядке" относительно привычно дробной десятичной нотации. Но надо понимать, что цепочки цифр -- это не числа, они образуют вполне самостоятельную алгебраическую структуру, изоморфную (при определённых условиях) той или иной числовой системе. Большую часть вещественных чисел составляют невычислимые числа, для которых неизвестен способ их представления в форме цепочки цифр или даже в форме комбинации из вычислимых чисел. Каноническое разложение p-адического числа -- это не p-адические число, а одно из его представлений, причём, не самое удобное или эффективное, просто оно интуитивно понятно в силу нашей привычки оперировать позиционной нотацией. Самое главное, p-адические числа не являются представлением привычных нам целых, рациональных или вещественных чисел, они образуют самостоятельную алгебраическую систему, в которой есть образы инъективных гомоморфизмов (однозначных отображений) из систем вещественных чисел, но есть и иные объекты, у которых нет никаких вещественных аналогов. Например, в кольцах с делителями нуля существуют нетривиальные автоморфные числа (числа, которые не меняются при возведении в произвольную натуральную степень). В вещественных и комплексных числах этими свойствами обладают только 0 и 1, а, например, в 10-адических числах есть ещё два таких числа: …392256259918212890625 и …607743740081787109376, vы встречали их "родителей" (5 и 6) в базовой модулярной арифметике $$\mathbb{Z}/10\mathbb{Z}$$. А в $$\mathbb{Z}/30\mathbb{Z}$$ их уже шесть! Если основание простое и мы имеем дело с полем с нормальной арифметикой, то нетривиальных автоморфных чисел уже не будет.

Важно осознать, что существование однозначного отображения любого рационального и многих алгебраических чисел в p-адическое поле, не гарантирует, что результат вычислений, произведённых с образами этих чисел, имеет вещественный аналог. В общем, перейти p-адический мир не трудно, а вот вернуться оттуда можно не всегда.

Это не так уж и необычно, для числовых систем. Множество вещественных чисел $$\mathbb{R}$$ включает в себя множество рациональных $$\mathbb{Q}$$, но кроме него $$\mathbb{R}$$ содержит в себя все пределы фундаментальных последовательностей, сходящихся в $$\mathbb{Q}$$, но не ему принадлежащих. Классические примеры таких пределов: $$\sqrt{2}, e, \pi$$. Первое можно получить как предел последовательности конечных цепных дробей или шагов метода Ньютона, а второе и третье – в виде последовательности частичных сумм рядов Тэйлора и Лейбница. Все без исключения элементы этих последовательностей рациональны, а их пределы -- нет. И рациональных аналогов этим числам найти не удастся. Таким образом, добавляя к $$\mathbb{Q}$$ все возможные пределы сходящихся последовательностей из элементов $$\mathbb{Q}$$, мы пополняем его до чего-то принципиально большего. 

Такое же ключевое свойство, отличает множество $$\mathbb{Q}_p$$ от сколь угодно больших, но конечных колец $$\mathbb{Z}/p^k\mathbb{Z}$$, породивших его. Оно включает в себя все пределы сходящихся последовательностей из своих элементов (сходящихся в особом, p-адическом смысле). Это позволяет рассуждать о непрерывности и задействовать ряд методов анализа, использующие понятия пределов и производных, метод Ньютона, ряды Тэйлора, а вслед за этим экспоненты, логарифмы, тригонометрию, гамма- и дзета-функцию и прочие инструменты! Все они будут заметно отличаться от своих вещественных аналогов, сохраняя, впрочем, свои главные свойства, и работать смогут не всегда, но их наличие очень важно, когда речь заходит о серьёзной работе с числовыми системами.

Наконец, поле $$\mathbb{Q}_p$$ можно алгебраически замкнуть, расширив его корнями алгебраических уравнений и преватив в поле p-адических комплексных чисел $$\mathbb{C}_p$$, а оно уже оказывается изоморфным полю комплексных чисел, построенному на основе вещественных чисел. То есть, наряду со стандартной цепочкой вложений числовых систем:
$$\mathbb{Z} \subset \mathbb{Q} \subset \mathbb{R} \subset \mathbb{C}$$, 
можно строить альтернативные цепочки 
$$\mathbb{Z}/p\mathbb{Z} \subset \mathbb{Z}_p \subset \mathbb{Q}_p \subset \mathbb{C}_p \simeq \mathbb{C}$$, которые начинаются с конечных полей вычетов, и достигают алгебраического замыкания, минуя вещественные числа $$\mathbb{R}$$. Между этими альтернативными цепочками есть сложные родственные связи: любое кольцо $$\mathbb{Z}_p$$ включает в себя кольцо $$\mathbb{Z}$$, а поле $$\mathbb{Q}_p$$ имеет подполем $$\mathbb{Q}$$. Однако если мы устремим $$p$$ к бесконечности, и $$\mathbb{Z}_p$$ и $$\mathbb{Q}_p$$ превратятся... в $$\mathbb{N}$$ -- во множество натуральных чисел, представляющее множество цифр в $$\infty$$-ичной системе счисления (до второй цифры в каноническом разложении дело так и не дойдёт). 

В середине XX века Александр Островский доказал, что иных путей, ведущих к полным алгебраическими числовым системам не существует. Это значит, что мы перечислили все возможные числовые системы, содержащие свободное кольцо (изоморфное кольцу целых чисел), свободное поле (изоморфное полю рациональных чисел), а также их пополнение и алгебраическое замыкание.

Есть ещё один практический аспект, деающий p-адические числа полезным инструментом и за пределами чистой теории чисел. Одна из досадных неприятностей при вычислении чисел в позиционной записи состоит в несимметричности операции переноса -- он всегда делается от младшего разряда к старшему, то есть, справа налево. В этом отношении бесконечный "хвост" цифр, уходящий налево принципиально лучше бесконечного "хвоста", уходящего направо. Ведь переносы переходят именно справа, так что переполнение разряда где-то далеко в бесконечном ряду цифр при любой арифметической операции, может, в принципе, передаваясь по цепочке, повлиять на сколь угодно большой разряд. По существу, каждая цифра, действительного числа, вычислимого в позиционной записи, хранит потенциально бесконечную информацию о всех своих соседях справа. С этим связаны проблемы округления и вытекающая из них неустойчивость вычислительных алгоритмов, а также то, что дробные числа могут иметь два различных позиционнных представления, например, $$1/2 = 0.5 = 0.4(9)$$. Это значит, что отображение между рациональными числами и их позиционным представлением не биективно, и дело тут уже не в округлении, а гораздо глубже. Это нарушение биективности до сих пор не даёт некоторым математикам (например, Норберту Уайлдбергеру) покоя и они ищут возможность избавиться от него.

В тоже самое время, арифметические действия, выполняемые поразрядно над целыми числами, которые "растут" только влево, не могут повлиять на цифры, которые уже вычислены. Обрывание цепочки где-то далеко слева никак не изменит уже известных нам младших разрядов.

На практике это заключается в следующем. Работая с числами с плавающей точкой, мы постоянно чувствуем конечность разрядности наших вычислительных машин: 0.2 + 0.1 ==> 0.30000000000000004, знакомо? При этом неважно с какими числами мы работаем, с большими или маленькими, ошибки округления неизбежны, и, если можно так выразиться, плотно обступают любые числа. В то же самое время, конечность разрядов в целочисленных типах никак не влияет на точность вычислений для чисел, далёких от верхней границы, которая для 64 или даже 32 разрядной арифметики уже весьма и весьма велика! Потому так ценятся целочисленные алгоритмы, могущие заменить возню с плавающей точкой. Превращая рациональные числа в p-адические, мы переводим их в область целых чисел, в которой обрывание бесконечной цепочки цифр слева, не затрагивает цифры, уже полученные в более младших разрядах. 

В [этой]() основательной статье, которую я рекомендую всем заинтересовавшимся данной темой, приводится пример вычислительной устойчивости стандартных матричных операций в действительных и в p-адических числах. Вот, например как меняется число верных цифр при обращении матрицы Гильберта, простой, но неприятной матрицы, содержащей простые дроби. В обоих случаях использовалось одинаковое число бит для конечного представления числа.

+-----------------+----+----+----+----+----+----+----+----+----+----+----+
| Размер матрицы  | 5  | 6  | 7  | 8  | 9  | 10 | 11 | 12 | 13 | 50 | 100|
+-----------------+----+----+----+----+----+----+----+----+----+----+----+
| IEEE            | 40 | 34 | 28 | 25 | 19 | 14 | 9  | 4  | 0  | –  | –  |
+-----------------+----+----+----+----+----+----+----+----+----+----+----+
| $$\mathbb{Q}_2$$| 52 | 52 | 51 | 51 | 51 | 51 | 51 | 51 | 51 | 49 | 48 |
+-----------------+----+----+----+----+----+----+----+----+----+----+----+

Всё это выглядит впечатляюще, но отчего мы до сих пор не отказались от чисел с плавающей точкой и не перешли на 2-адические числа, раз уж мы всё равно используем похожие на них двоичные числа для оцифровывания всего на свете? Всё дело в топологии.

## Почему мы не проходим p-адические числа в школе?

Топология -- это не только про бублики и бутылки Клейна, как может показаться после знакомства с популярными введениями, она про такие свойства пространств и математических объектов, как непрерывность, связность, про их метрические свойства и отношения между объуктами, сохраняющие эти свойства. Так вот с топологическими свойствами у системы p-адических чисел беда! Их нельзя выстроить по порядку вдоль прямой, как мы привыкли это делать с целыми, рациональными или вещественными числами. Расстояние между двумя p-адическими числами, то есть, абсолютное значение их разности, которое позволяет рассуждать о точности вычислений и о сходимости последовательностей, может быть вычислено единственным способом и он абсолютно не согласуется каким-либо порядком в $$\mathbb{R}$$. Более того, "между" любыми двумя целыми p-адическими числами можно отыскать сколько угодно других целых p-адических чисел, которые в привычной метрике оказались бы не просто далеко, а бесконечно далеко друг от друга! Впрочем, я взял слово "между" в кавычки, потому что и оно не совсем корректно, ибо p-адические числа топологически размещаются не на каком-то гладком многообразии, а на древо-подобной структуре. При этом пересечение всех открытых интервалов (шаров) образует не континуум, как в топологии действительных чисел, а фрактальное несвязное канторово множество пример которого показан на рисунке в заголовке статьи. Впрочем, и сами шары в топологическом p-адическом пространстве весьма странные: любая точка шара, в том числе и граничная, является его центром. Так что мыслить шагами или отрезками на числовой прямой, любо непрерывными перемещениями в пространстве никак не получится, а это очень важная деталь в математической картине физического мира, в котором малому относительному смещению двух точек в пространстве или времени соответствует малое изменение расстояния между ними. В p-адическом мире на это рассчитывать не приходится. 

С чем же связана такая оригинальная топология? Нельзя ли было построить её как-нибудь иначе? Увы, теорема Островского уверждает, что существует только два способа построения нетривиального самосогласованного нормирования для числовых систем, один -- привычный для нас вещественный, а другой -- p-адический. Так что, говоря о p-адических числах совершенно необходимо разобраться как устроено p-адическое метрическое пространство. И в этом нам опять поможет позиционная запись. 

Каким образом мы выясняем близки ли два вещественных числа друг к другу, если они представлены не кучками фасолин или отрезками на прямой, а цифрами? Начиная со старшего разряда мы сравниваем между собой цифры этих двух чисел, и чем длиннее оказывается непрерывная цепочка совпадающих цифр, тем ближе друг к другу они оказываются. Разница между двумя числами  123.456**7**89 и 123.456**6**89  существенно меньше, чем между 1**2**3.456789 и 1**1**3.456789, хотя в обоих случаях отличие состоит в единственной цифре. Всё дело в позиции отличающихся цифр. Разговор о расстоянии между числами проще вести если одно число равно нулю, тогда можно рассуждать об абсолютном значении и нормировании числа (valuation по-английски), а для сравнения ненулевых чисел использовать абсолютное значение их разности. В мире вещественных чисел абсолютное значение совпадает с модулем числа. Так, разница между 123.456**7**89 и 123.456**6**89 составляет 0.0001, а между  1**2**3.456789 и 1**1**3.456789 -- 10. Число 0.00001 ближе к нулю чем 0.02, поскольку цепочка из четырёх нулей после десятичной точки больше цепочки из одного нуля.

В сходящихся последовательностях вещественных чисел увеличивается число цифр, совпадающих в левой части числа. Вот, например, как выглядит приближение к числу $$\sqrt{2}$$ методом Ньютона в вещественных числах:

````
1.0000000000000000
1.5000000000000000
1.4166666666666665
1.4142156862745097
1.4142135623746899
1.4142135623730950
````

А теперь перейдём в p-адический мир и перевернём всё задом-наперёд. Числа у нас имеют бесконечный хвост уходящий налево, при этом степень основания продолжает расти как росла, в том же направлении! Как сравнивать такие числа? На первом курсе Университета ходила шутка: "Какое число больше $$e$$ или $$\pi$$, если читать их с конца?" Так вот, теперь это не шутка, а серьёзный вопрос.

Единственный способ сравнения, который нам остаётся, это такое же сравнение по цифрам, но совпадающие цифры мы можем считать только справа налево, начиная с младшего разряда. Вот, например, как выглядит приближение к тому же $$\sqrt{2}$$ методом Ньютона, но в $$\mathbb{Z}_7$$:

````
…000000000000000000000000000000000000000<b>4</b>
…5151515151515151515151515151515151515154
…0452300452300452300452300452300452300454
…2202010030046244242322523014664645450454
…5455641253041334120254404655400245450454
…6416163312301130043502554655400245450454
…4026305612301130043502554655400245450454 
````

Последовательность, и правда, сходится в p-адическом смысле: с каждым шагом число не меняющихся цифр растёт, но в старших разрядах царит хаос. В пределе мы получим то самое целое число, которое при возведении в квадрат будет в точности равно 2, но путь к нему с точки зрения вещественного порядка будет выглядеть бешеным метанием по числовой оси. Если мы будем рассматривать разности между последовательными членами нашей приближений, то цепочки совпадающих цифры (выделенные жирным), превратятся в постоянно увеличивающуюся цепочку нулей. Именно так выглядит последовательность p-адических чисел, монотонно убывающая по их абсолютному значению. Формально абсолютное значение на $$\mathbb{Z}_p$$ определяют так: $$|x|_p = p^{-k}$$, где $$k$$ -- это число нулей в правой части числа, то есть, позиция младшего ненулевого разряда числа. Элемент $$\mathbb{Q}_p$$ записывается в общем виде как $$x = u \cdot p^v$$, при этом обратимый множитель $$u$$ всегда имеет абсолютное значение равное 1, а $$|x|_p = p^{-v}$$.

Округление p-адических чисел, таким образом, состоит в обрывании цепочки цифр слева. А благодаря тому, что при арифметических операциях перенос происходит от младшего разряда к старшему, при таком округлении мы не теряем никакой информации. Так что мы можем проводить вычисления с конечными округлёнными представлениями p-адических чисел, но, увы, из-за их патологической топологии мы не сможем ни построить график, ни, как-то вразумительно изобразить эти числа геометрически.

Для чего же они используются на практике? Конечно же, в основном, в теории чисел и абстрактной алгебре, но вот уже более полувека они стали рабочими лошадками в физике (квантовой механике, теории струн), в теории динамических систем и в методах генерации псевдослучайных чисел, в которых корявая p-адическая топология превратилась из бага в фичу.

## Практические рецепты и алгоритмы

Естественным образом возникает искушение представить p-адические числа в каноническом разложении, то есть, как последовательности (списки) цифр, а всю арифметику реализовать поразрядно, "в столбик". Это может быть поучительно, но не эффективно. Мы уже достаточно теоретически подготовлены, чтобы понять, что p-адические числа -- это не цепочка цифр, а, в первую очередь, числовая система. В роли системы, представляющей кольцо целых p-адических чисел с ограниченной точностью в $$k$$ разрядов, может выступать замечательное кольцо $$\mathbb{Z}/p^k\mathbb{Z}$$, содержащее обычные целые числа с обычной модулярной арифметикой. По существу, понижая $$\mathbb{Z}_p$$ до $$\mathbb{Z}_{p^k}$$, мы ограничиваемся лишь первой цифрой канонического разложения в этом кольце. Сложение, вычитание, умножение и деление для первой цифры будет в полной мере соответствовать p-адическим операциям, а так как это просто большое целое число, то оно может быть реализовано очень эффективно, например, с использованием [GMP](http://gmplib.org/) или подобных ей библиотек. Таким образом, на практике стоит рассматривать p-адические числа (и рациональные и трансцедентные) как большие целые (big int), вся арифметика с которыми выполняется по модулю $$p^k$$.

Первым делом нужно научиться переходить к ним от вещественных чисел, выраженных с конечной точностью, и возвращаться обратно так, чтобы по-возможности, не потерять согласованности между арифметиками и точностями величин, используемых в этих числовых системах. В нашем контексте точность вещественных чисел определяется не числом значащих цифр десятичного разложения, а максимальным абсолютным значением $$N$$ для числителя и знаменателя дроби, приближающей вещественные числа. Для перевода числа $$x = \frac{r}{s} = r \cdot s^{-1} \in Q$$ в $$\mathbb{Z}/p^k\mathbb{Z}$$ достаточно найти обратный элемент для $$s$$ в $$\mathbb{Z}/p^k\mathbb{Z}$$, то есть элемент $$q = s^{-1}$$, такой, что $$q\cdot s = 1\ \mod\ p^k$$. Это сравнение эквивалентно уравнению Безу $$s\cdot q + m\cdot p^k = 1$$, которое решается расширенным алгоритмом Евклида, ели $$\gcd(s, p) = 1$$. Если $$r, s \leq N < \sqrt{p^k / 2}$$ то при переходе в модулярную арифметику мы не потеряем информации о числах $$r$$ и $$s$$.

````
Алгоритм для нахождения округлённого p-адического образа числа $$x \in Q$$, как элемента $$\mathbb{Z}/p^k\mathbb{Z}$$
1. Выделить из числителя или знаменателя множитель $$p$$, то есть, представить $$x = \frac{r}{s}\cdot p^v$$.
   1.1 Если $$gcd(s, p) = c \neq 1$$, то $$x = \frac{r}{s'} \cdot p^(v+v')$$, где $$s = s' \cdot c^v'$$ и вместо $$s$$ и $$v$$ далее нужно работать с $$s'$$ и $$v+v'$$.
2. Найти $$q = s^{-1}$$, решив уравнение Безу $$s\cdot q + m \cdot p^k = 1$$
3. Результатом будет p-адическое число $$r\cdot q\cdot p^v$$

Пример 1. Найдём образ числа $$x = 637/713$$ в $$\mathbb{Z}_7$$, округлённом так, чтобы можно было без потери точности восстанавливать числа с числителем и знаменателем в пределах 1000.
0. Найдём необходимую для обеспечения точности степень 7. $$1000^2 < 7^k \doublerightarrow k = 2 \cdot 3\cdot log_7 10 = 7$$, значит мы будем работать в кольце вычетов по модулю $$7^7 = 823543$$
1. Выделяем из числа степени 7: $$x = 7^2\cdot 13/713$$. Поскольку 7 -- число простое шаг 1.1 не потребуется.
2. Находим обратный элемент для знаменателя $$713^{-1} = 382318 \mod 823543.
3. Получаем результат: $$x = 7^2 * 13 \cdot 382318 = 591381 \mod 823543$$. 
````

Инструменты для работы с p-адическими числами есть во многих математических пакетах, таких как Sage, Maple, Magma и им подобных, на github выложены библиотеки для многих языков, а теперь такая библиотека есть для Haskell. 

## Пара слов о библиотеке <code>padic</code>

Для Haskell Андреем Лелеченко написан отличный пакет модулярной арифметики [mod](https://hackage.haskell.org/package/mod), с очень удобным интерфейсом и эффективной реализацией. Он и послужил основой для моей библиотеки. Каноническое разложение в список цифр используется только для текстового представления чисел, а вся арифметика производится в целочисленной модулярной арифметике.

Простейшая работа с библиотекой выглядит так:

````hs
> :set -XDataKinds
> 45 :: Z 5
140
> -45 :: Z 5
(4)310
> toInteger it
-45
> 13 / 7 :: Q 10
(714285)9.0
> toRational it
13 % 7
> sqrt 11 :: Q 5
…231012244200433234102330200211.0
> sqrt 11 :: Z' 5 40
…00104441102231221020231012244200433234102330200211.0
> toRational (it ^ 2)
11 % 1
> sin 49 :: Q 7
…013021253020521111000100.0
> fromDigits [1,2,3,0,3,2,1] :: Z 4
1230321
````
Всё достаточно удобно и интуитивно.

Продемонстрируем накопление ошибки округления при работе с IEEE и её отсутствие при работе с 10-адическими числами:

````hs
> iterate (1 / 3 + ) 0 !! 300000 :: Double
99999.99999968921
> iterate (1 `div` 3 + ) 0 !! 300000 :: Z 10
100000
````
В пакете определено достаточно большое количество функций, алгебраических и трасцедентных, реализован метод Ньютона (в духе леммы Гензеля). Так, например, можно решать алгебраические уравнения: 

````hs
> henselLifting (\x -> x^3 - 2*x +3) (\x -> 3*x^2 -2) :: [Z 7]
[…106254154414566525205522]
````
Производную надо задавать явно, но можно воспользоваться автоматическим дифферернцированием, которое я не захотел тащить в библиотеку, чтобы не утяжелять её зависимости.

Можно найти 10-адические автоморфные числа и убедиться в том, что в какую бы степень мы их не возвели, они останутся неизменными:
````hs
> aut = henselLifting (\x -> x^2 - x) (\x -> 2*x - 1) :: [Z 10]
> aut
[0,1,…392256259918212890625,…607743740081787109376]
> and [ x == x^i | x <- aut, i <- [2..200] ]
True
````

А вот ещё числа, которых не встретишь в вещественном мире: n различных корней n-ной степени из единицы, как в комплексных числах (правда, они существуют не для всех n).

````hs
> unityRoots 3 :: [Q 7]
[1.0,…053116412125443426203642.0,…613550254541223240463024.0]
> (^3) <$> it
[1.0,1.0,1.0]
> unityRoots 6 :: [Q 7]
[1.0,…053116412125443426203642.0,…053116412125443426203643.0,
…613550254541223240463024.0,…613550254541223240463025.0,(6).0]
> (^6) <$> it
[1.0,1.0,1.0,1.0,1.0,1.0]
````

Методом Гензеля можно решать и трансцедентные уравнения тоже. Например, вот 7-адическое число, синус которого равен $$7^2$$:

````hs
> x = head $ henselLifting (\x -> sin x - 7^2) cos :: Q 7
> x
…313125366542105556000100.0
> sin x
100.0 -- это 49 в 7-ричном представлении.
````

Из-за особенностей округления в р-адических числах в них можно работать с невероятно большими числами, правда, только с младшими разрядами, наименее значащими в вещественном мире, но в модулярных арифметиках и они способны нести полезную информацию. Например, нам не состоавит особого труда вычислить младшие разряды знаменитого [числа Грэма](https://ru.wikipedia.org/wiki/%D0%A7%D0%B8%D1%81%D0%BB%D0%BE_%D0%93%D1%80%D1%8D%D0%BC%D0%B0). Оно опреляется через т.н. гипероперации -- обобщения арифметических операций. Определим одну из них -- [тетрацию](https://ru.wikipedia.org/wiki/%D0%A2%D0%B5%D1%82%D1%80%D0%B0%D1%86%D0%B8%D1%8F), то есть башню степеней <code>a ^^^ b = a ^ (a ^ (a ... a^a))</code> состоящую из <code>b</code> этажей.

````hs
(^^^) :: Radix p prec => Z' p prec -> Z' p prec -> Z' p prec 
a ^^^ 0 = 1
a ^^^ 1 = a
a ^^^ b = a `zPow` (a ^^^ (b - 1))
````
Здесь функция <code>zPow</code> -- это p-адическое возведение в степень для кольца целых p-адических чисел. Значение этой функции бысто становятся такими большими, что в обычных вещественных числах с ними уже не поработаешь, тогда как в p-адической арифметике вычисления не занимают сколь-нибудь заметного времени. 

Число Грэма строится на основе тетрации тройки. Нетрудно убедиться, что последовательность $$a _i = 3 \text{^^^} i$$ сходится в $$\mathbb{Z}_10$$ к некоторому предельному числу $$\mathscr{G}$$, которое решает уравнение $$3^\mathscr{G} = \mathscr{G}$$:

````hs
> λ> 3 ^^^ 2 :: Z 10
27
λ> 3 ^^^ 3 :: Z 10
7625597484987
λ> 3 ^^^ 4 :: Z 10
…206738945776100739387
λ> 3 ^^^ 5 :: Z 10
…315006939489660355387
λ> 3 ^^^ 6 :: Z 10
…913333445425126595387
λ> 3 ^^^ 10 :: Z 10
…254100942846464195387
λ> 3 ^^^ 100 :: Z 10
…104575627262464195387
λ> g = 3 ^^^ 1000 :: Z 10
…104575627262464195387
````
Существование этого предела означает, что какую бы огромную башню степеней тройки мы бы ни построили (а для числа Грэма она больше чем число планковских расстояний, укладывающихся в диаметр видимой Вселенной), мы получим всего лишь конечное округление числа $$\mathscr{G}$$! В русскоязычной статье из Википедии приводится 50 младших разрядов числа Грэма. Работая в p-адической арифметике, мы легко можем получить хоть 50, хоть 100 последних цифр этого монстра:

````hs
> g = 3 ^^^ 1000 :: Z' 10 100
> g
…9404248265018193851562535796399618993967905496638003222348723967018485186439059104575627262464195387
> 3 `zPow` g == g
True
````

## Некоторые детали реализации

Работа над библиотекой <code>padic</code> доставила массу удовольствия! 

Особенно приятно, что при реализации этой библиотеки мне удалось задействовать элементы зависимых типов, обеспечив глубокую типобезопасность и непредставимость некорректных данных, а таже переведя часть вычислений на этап компиляции. На уровне типов определяется как модуль в котором мы работаем, так и задаваемая точность. Если точность не указана, она подбирается такой, чтобы можно было корректно реконструировать рациональные числа с числителями и знаменателями в пределах типа `Int32` из p-адического представления. На уровне типов так же происходит и согласование модуля p-адического числа $$p$$ и модуля его внутреннего представления $$p^k$$ c требуемой точностью. Для этого используются зависимые типы, предоставляемые типами-литералами (type literals) и семействами типов (type families).

</html>
